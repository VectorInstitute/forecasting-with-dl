

<!DOCTYPE html>


<html lang="en" >

  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" /><meta name="generator" content="Docutils 0.18.1: http://docutils.sourceforge.net/" />

    <title>Baselines, Prophet and NeuralProphet &#8212; Forecasting Workshop</title>
  
  
  
  <script data-cfasync="false">
    document.documentElement.dataset.mode = localStorage.getItem("mode") || "";
    document.documentElement.dataset.theme = localStorage.getItem("theme") || "light";
  </script>
  
  <!-- Loaded before other Sphinx assets -->
  <link href="../_static/styles/theme.css?digest=e353d410970836974a52" rel="stylesheet" />
<link href="../_static/styles/bootstrap.css?digest=e353d410970836974a52" rel="stylesheet" />
<link href="../_static/styles/pydata-sphinx-theme.css?digest=e353d410970836974a52" rel="stylesheet" />

  
  <link href="../_static/vendor/fontawesome/6.1.2/css/all.min.css?digest=e353d410970836974a52" rel="stylesheet" />
  <link rel="preload" as="font" type="font/woff2" crossorigin href="../_static/vendor/fontawesome/6.1.2/webfonts/fa-solid-900.woff2" />
<link rel="preload" as="font" type="font/woff2" crossorigin href="../_static/vendor/fontawesome/6.1.2/webfonts/fa-brands-400.woff2" />
<link rel="preload" as="font" type="font/woff2" crossorigin href="../_static/vendor/fontawesome/6.1.2/webfonts/fa-regular-400.woff2" />

    <link rel="stylesheet" type="text/css" href="../_static/pygments.css" />
    <link rel="stylesheet" href="../_static/styles/sphinx-book-theme.css?digest=14f4ca6b54d191a8c7657f6c759bf11a5fb86285" type="text/css" />
    <link rel="stylesheet" type="text/css" href="../_static/togglebutton.css" />
    <link rel="stylesheet" type="text/css" href="../_static/copybutton.css" />
    <link rel="stylesheet" type="text/css" href="../_static/mystnb.4510f1fc1dee50b3e5859aac5469c37c29e427902b24a333a5f9fcb2f0b3ac41.css" />
    <link rel="stylesheet" type="text/css" href="../_static/sphinx-thebe.css" />
    <link rel="stylesheet" type="text/css" href="../_static/design-style.4045f2051d55cab465a707391d5b2007.min.css" />
  
  <!-- Pre-loaded scripts that we'll load fully later -->
  <link rel="preload" as="script" href="../_static/scripts/bootstrap.js?digest=e353d410970836974a52" />
<link rel="preload" as="script" href="../_static/scripts/pydata-sphinx-theme.js?digest=e353d410970836974a52" />

    <script data-url_root="../" id="documentation_options" src="../_static/documentation_options.js"></script>
    <script src="../_static/jquery.js"></script>
    <script src="../_static/underscore.js"></script>
    <script src="../_static/_sphinx_javascript_frameworks_compat.js"></script>
    <script src="../_static/doctools.js"></script>
    <script src="../_static/clipboard.min.js"></script>
    <script src="../_static/copybutton.js"></script>
    <script src="../_static/scripts/sphinx-book-theme.js?digest=5a5c038af52cf7bc1a1ec88eea08e6366ee68824"></script>
    <script>let toggleHintShow = 'Click to show';</script>
    <script>let toggleHintHide = 'Click to hide';</script>
    <script>let toggleOpenOnPrint = 'true';</script>
    <script src="../_static/togglebutton.js"></script>
    <script>var togglebuttonSelector = '.toggle, .admonition.dropdown';</script>
    <script src="../_static/design-tabs.js"></script>
    <script>const THEBE_JS_URL = "https://unpkg.com/thebe@0.8.2/lib/index.js"
const thebe_selector = ".thebe,.cell"
const thebe_selector_input = "pre"
const thebe_selector_output = ".output, .cell_output"
</script>
    <script async="async" src="../_static/sphinx-thebe.js"></script>
    <script>window.MathJax = {"options": {"processHtmlClass": "tex2jax_process|mathjax_process|math|output_area"}}</script>
    <script defer="defer" src="https://cdn.jsdelivr.net/npm/mathjax@3/es5/tex-mml-chtml.js"></script>
    <script>DOCUMENTATION_OPTIONS.pagename = 'demos/demo1_prophet_neuralprophet_testset';</script>
    <link rel="index" title="Index" href="../genindex.html" />
    <link rel="search" title="Search" href="../search.html" />
    <link rel="next" title="PyTorch Forecasting - NBEATS" href="demo2_pytorch_forecasting-NBEATS-CPI.html" />
    <link rel="prev" title="Intro to Time Series Forecasting and Evaluation" href="../intro_to_forecasting/intro_time_series_2.html" />
  <meta name="viewport" content="width=device-width, initial-scale=1"/>
  <meta name="docsearch:language" content="en"/>
  </head>
  
  
  <body data-bs-spy="scroll" data-bs-target=".bd-toc-nav" data-offset="180" data-bs-root-margin="0px 0px -60%" data-default-mode="">

  
  
  <a class="skip-link" href="#main-content">Skip to main content</a>
  
  <input type="checkbox"
          class="sidebar-toggle"
          name="__primary"
          id="__primary"/>
  <label class="overlay overlay-primary" for="__primary"></label>
  
  <input type="checkbox"
          class="sidebar-toggle"
          name="__secondary"
          id="__secondary"/>
  <label class="overlay overlay-secondary" for="__secondary"></label>
  
  <div class="search-button__wrapper">
    <div class="search-button__overlay"></div>
    <div class="search-button__search-container">
<form class="bd-search d-flex align-items-center"
      action="../search.html"
      method="get">
  <i class="fa-solid fa-magnifying-glass"></i>
  <input type="search"
         class="form-control"
         name="q"
         id="search-input"
         placeholder="Search this book..."
         aria-label="Search this book..."
         autocomplete="off"
         autocorrect="off"
         autocapitalize="off"
         spellcheck="false"/>
  <span class="search-button__kbd-shortcut"><kbd class="kbd-shortcut__modifier">Ctrl</kbd>+<kbd>K</kbd></span>
</form></div>
  </div>
  
    <nav class="bd-header navbar navbar-expand-lg bd-navbar">
    </nav>
  
  <div class="bd-container">
    <div class="bd-container__inner bd-page-width">
      
      <div class="bd-sidebar-primary bd-sidebar">
        

  
  <div class="sidebar-header-items sidebar-primary__section">
    
    
    
    
  </div>
  
    <div class="sidebar-primary-items__start sidebar-primary__section">
        <div class="sidebar-primary-item">
  

<a class="navbar-brand logo" href="../README.html">
  
  
  
  
    
    
      
    
    
    <img src="../_static/logo.jpg" class="logo__image only-light" alt="Logo image"/>
    <script>document.write(`<img src="../_static/logo.jpg" class="logo__image only-dark" alt="Logo image"/>`);</script>
  
  
</a></div>
        <div class="sidebar-primary-item"><nav class="bd-links" id="bd-docs-nav" aria-label="Main">
    <div class="bd-toc-item navbar-nav active">
        
        <ul class="nav bd-sidenav bd-sidenav__home-link">
            <li class="toctree-l1">
                <a class="reference internal" href="../README.html">
                    Forecasting Bootcamp
                </a>
            </li>
        </ul>
        <p aria-level="2" class="caption" role="heading"><span class="caption-text">Introduction</span></p>
<ul class="nav bd-sidenav">
<li class="toctree-l1"><a class="reference internal" href="../intro_to_forecasting/intro_time_series.html">Introduction to Time Series Analysis</a></li>
<li class="toctree-l1"><a class="reference internal" href="../intro_to_forecasting/intro_time_series_2.html">Intro to Time Series Forecasting and Evaluation</a></li>
</ul>
<p aria-level="2" class="caption" role="heading"><span class="caption-text">Univariate Forecasting</span></p>
<ul class="current nav bd-sidenav">
<li class="toctree-l1 current active"><a class="current reference internal" href="#">Baselines, Prophet and NeuralProphet</a></li>
<li class="toctree-l1"><a class="reference internal" href="demo2_pytorch_forecasting-NBEATS-CPI.html">PyTorch Forecasting - NBEATS</a></li>
<li class="toctree-l1"><a class="reference internal" href="demo2_pytorch_forecasting.html">PyTorch Forecasting - NBEATS, DeepAR</a></li>
<li class="toctree-l1"><a class="reference internal" href="demo3_rolling_cv_prophet.html">Rolling Cross Validation for Monthly CPI Forecasting</a></li>
</ul>
<p aria-level="2" class="caption" role="heading"><span class="caption-text">Multivariate Forecasting</span></p>
<ul class="nav bd-sidenav">
<li class="toctree-l1"><a class="reference internal" href="../multivariate_demos/deepar_electricty.html">Multivariate Forecasting with DeepAR</a></li>
<li class="toctree-l1"><a class="reference internal" href="../multivariate_demos/nbeats_electricity.html">Multivariate Forecasting with NBEATS</a></li>
<li class="toctree-l1"><a class="reference internal" href="../multivariate_demos/nhits_quantile.html">Multivariate quantiles and long horizon forecasting with N-HiTS</a></li>
</ul>
<p aria-level="2" class="caption" role="heading"><span class="caption-text">Multivariate Long Sequence Timeseries Forecasting</span></p>
<ul class="nav bd-sidenav">
<li class="toctree-l1"><a class="reference internal" href="../multivariate_lstf_demos/autoformer_traffic.html">Multivariate Forecasting Long Sequence Time Series with Autoformer</a></li>
<li class="toctree-l1"><a class="reference internal" href="../multivariate_lstf_demos/nhits_traffic.html">Multivariate Forecasting Long Sequence Time Series with NHITS</a></li>
</ul>
<p aria-level="2" class="caption" role="heading"><span class="caption-text">Appendix</span></p>
<ul class="nav bd-sidenav">
<li class="toctree-l1 has-children"><a class="reference internal" href="../datasets/datasets_intro.html">Datasets Description</a><input class="toctree-checkbox" id="toctree-checkbox-1" name="toctree-checkbox-1" type="checkbox"/><label class="toctree-toggle" for="toctree-checkbox-1"><i class="fa-solid fa-chevron-down"></i></label><ul>
<li class="toctree-l2"><a class="reference internal" href="../datasets/can_climate_data/load_raw_data.html">Load data files</a></li>


<li class="toctree-l2"><a class="reference internal" href="../datasets/can_climate_data/data_explore.html">Load weather data and station metadata</a></li>




<li class="toctree-l2"><a class="reference internal" href="../datasets/m5/load_m5_dataset.html">M5 Data Preparation</a></li>

</ul>
</li>
</ul>

    </div>
</nav></div>
    </div>
  
  
  <div class="sidebar-primary-items__end sidebar-primary__section">
  </div>
  
  <div id="rtd-footer-container"></div>


      </div>
      
      <main id="main-content" class="bd-main">
        
        

<div class="sbt-scroll-pixel-helper"></div>

          <div class="bd-content">
            <div class="bd-article-container">
              
              <div class="bd-header-article">
<div class="header-article-items header-article__inner">
  
    <div class="header-article-items__start">
      
        <div class="header-article-item"><label class="sidebar-toggle primary-toggle btn btn-sm" for="__primary" title="Toggle primary sidebar" data-bs-placement="bottom" data-bs-toggle="tooltip">
  <span class="fa-solid fa-bars"></span>
</label></div>
      
    </div>
  
  
    <div class="header-article-items__end">
      
        <div class="header-article-item">

<div class="article-header-buttons">





<div class="dropdown dropdown-launch-buttons">
  <button class="btn dropdown-toggle" type="button" data-bs-toggle="dropdown" aria-expanded="false" aria-label="Launch interactive content">
    <i class="fas fa-rocket"></i>
  </button>
  <ul class="dropdown-menu">
      
      
      
      <li><a href="https://colab.research.google.com/github/VectorInstitute/forecasting-bootcamp/blob/jupyter-book/./demos/demo1_prophet_neuralprophet_testset.ipynb" target="_blank"
   class="btn btn-sm dropdown-item"
   title="Launch onColab"
   data-bs-placement="left" data-bs-toggle="tooltip"
>
  

<span class="btn__icon-container">
  
    <img src="../_static/images/logo_colab.png">
  </span>
<span class="btn__text-container">Colab</span>
</a>
</li>
      
  </ul>
</div>






<div class="dropdown dropdown-source-buttons">
  <button class="btn dropdown-toggle" type="button" data-bs-toggle="dropdown" aria-expanded="false" aria-label="Source repositories">
    <i class="fab fa-github"></i>
  </button>
  <ul class="dropdown-menu">
      
      
      
      <li><a href="https://github.com/VectorInstitute/forecasting-bootcamp" target="_blank"
   class="btn btn-sm btn-source-repository-button dropdown-item"
   title="Source repository"
   data-bs-placement="left" data-bs-toggle="tooltip"
>
  

<span class="btn__icon-container">
  <i class="fab fa-github"></i>
  </span>
<span class="btn__text-container">Repository</span>
</a>
</li>
      
      
      
      
      <li><a href="https://github.com/VectorInstitute/forecasting-bootcamp/edit/jupyter-book/./demos/demo1_prophet_neuralprophet_testset.ipynb" target="_blank"
   class="btn btn-sm btn-source-edit-button dropdown-item"
   title="Suggest edit"
   data-bs-placement="left" data-bs-toggle="tooltip"
>
  

<span class="btn__icon-container">
  <i class="fas fa-pencil-alt"></i>
  </span>
<span class="btn__text-container">Suggest edit</span>
</a>
</li>
      
      
      
      
      <li><a href="https://github.com/VectorInstitute/forecasting-bootcamp/issues/new?title=Issue%20on%20page%20%2Fdemos/demo1_prophet_neuralprophet_testset.html&body=Your%20issue%20content%20here." target="_blank"
   class="btn btn-sm btn-source-issues-button dropdown-item"
   title="Open an issue"
   data-bs-placement="left" data-bs-toggle="tooltip"
>
  

<span class="btn__icon-container">
  <i class="fas fa-lightbulb"></i>
  </span>
<span class="btn__text-container">Open issue</span>
</a>
</li>
      
  </ul>
</div>






<div class="dropdown dropdown-download-buttons">
  <button class="btn dropdown-toggle" type="button" data-bs-toggle="dropdown" aria-expanded="false" aria-label="Download this page">
    <i class="fas fa-download"></i>
  </button>
  <ul class="dropdown-menu">
      
      
      
      <li><a href="../_sources/demos/demo1_prophet_neuralprophet_testset.ipynb" target="_blank"
   class="btn btn-sm btn-download-source-button dropdown-item"
   title="Download source file"
   data-bs-placement="left" data-bs-toggle="tooltip"
>
  

<span class="btn__icon-container">
  <i class="fas fa-file"></i>
  </span>
<span class="btn__text-container">.ipynb</span>
</a>
</li>
      
      
      
      
      <li>
<button onclick="window.print()"
  class="btn btn-sm btn-download-pdf-button dropdown-item"
  title="Print to PDF"
  data-bs-placement="left" data-bs-toggle="tooltip"
>
  

<span class="btn__icon-container">
  <i class="fas fa-file-pdf"></i>
  </span>
<span class="btn__text-container">.pdf</span>
</button>
</li>
      
  </ul>
</div>




<button onclick="toggleFullScreen()"
  class="btn btn-sm btn-fullscreen-button"
  title="Fullscreen mode"
  data-bs-placement="bottom" data-bs-toggle="tooltip"
>
  

<span class="btn__icon-container">
  <i class="fas fa-expand"></i>
  </span>

</button>


<script>
document.write(`
  <button class="theme-switch-button btn btn-sm btn-outline-primary navbar-btn rounded-circle" title="light/dark" aria-label="light/dark" data-bs-placement="bottom" data-bs-toggle="tooltip">
    <span class="theme-switch" data-mode="light"><i class="fa-solid fa-sun"></i></span>
    <span class="theme-switch" data-mode="dark"><i class="fa-solid fa-moon"></i></span>
    <span class="theme-switch" data-mode="auto"><i class="fa-solid fa-circle-half-stroke"></i></span>
  </button>
`);
</script>

<script>
document.write(`
  <button class="btn btn-sm navbar-btn search-button search-button__button" title="Search" aria-label="Search" data-bs-placement="bottom" data-bs-toggle="tooltip">
    <i class="fa-solid fa-magnifying-glass"></i>
  </button>
`);
</script>
<label class="sidebar-toggle secondary-toggle btn btn-sm" for="__secondary"title="Toggle secondary sidebar" data-bs-placement="bottom" data-bs-toggle="tooltip">
    <span class="fa-solid fa-list"></span>
</label>
</div></div>
      
    </div>
  
</div>
</div>
              
              

<div id="jb-print-docs-body" class="onlyprint">
    <h1>Baselines, Prophet and NeuralProphet</h1>
    <!-- Table of contents -->
    <div id="print-main-content">
        <div id="jb-print-toc">
            
            <div>
                <h2> Contents </h2>
            </div>
            <nav aria-label="Page">
                <ul class="visible nav section-nav flex-column">
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#data-loading">Data Loading</a><ul class="nav section-nav flex-column">
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#load-exchange-rate-data-file">Load exchange rate data file</a></li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#split-data-according-to-use-case">Split data according to use case</a></li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#iterating-over-test-examples">Iterating over test examples</a></li>
</ul>
</li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#evaluation-metrics">Evaluation Metrics</a></li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#baseline-forecasts">Baseline Forecasts</a><ul class="nav section-nav flex-column">
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#compute-error-metrics-over-the-baseline-forecasts">Compute error metrics over the baseline forecasts</a></li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#visualizing-forecasts-over-the-test-set">Visualizing forecasts over the test set</a><ul class="nav section-nav flex-column">
<li class="toc-h4 nav-item toc-entry"><a class="reference internal nav-link" href="#persistence-forecasts-at-max-lead-time">Persistence Forecasts At Max Lead Time</a></li>
<li class="toc-h4 nav-item toc-entry"><a class="reference internal nav-link" href="#mean-window-forecasts-at-max-lead-time">Mean Window Forecasts At Max Lead Time</a></li>
</ul>
</li>
</ul>
</li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#prophet">Prophet</a><ul class="nav section-nav flex-column">
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#data-preparation">Data Preparation</a></li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#model-initialization-and-fitting">Model Initialization and Fitting</a></li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#produce-forecasts">Produce Forecasts</a></li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#plotting-prophet-forecasts">Plotting Prophet Forecasts</a></li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#prophet-forecasts-at-max-lead-time">Prophet Forecasts At Max Lead Time</a></li>
</ul>
</li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#neuralprophet">NeuralProphet</a><ul class="nav section-nav flex-column">
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#data-formatting">Data Formatting</a></li>
</ul>
</li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#baseline-default-model">Baseline/Default Model</a><ul class="nav section-nav flex-column">
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#plot-all-forecasts">Plot all forecasts</a></li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#plot-all-forecasts-at-max-lead-time">Plot all forecasts at max lead time</a></li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#append-evaluation-metrics-to-results-df">Append evaluation metrics to <code class="docutils literal notranslate"><span class="pre">results_df</span></code></a></li>
</ul>
</li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#restricted-model">Restricted model</a><ul class="nav section-nav flex-column">
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#plot-forecasts-at-max-lead-time">Plot forecasts at max lead time</a></li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#id1">Append evaluation metrics to <code class="docutils literal notranslate"><span class="pre">results_df</span></code></a></li>
</ul>
</li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#model-with-sparse-neural-autoregression">Model with Sparse Neural Autoregression</a><ul class="nav section-nav flex-column">
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#id2">Plot forecasts at max lead time</a></li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#id3">Append evaluation metrics to <code class="docutils literal notranslate"><span class="pre">results_df</span></code></a></li>
</ul>
</li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#reflections-and-next-steps">Reflections and Next Steps</a></li>
</ul>
            </nav>
        </div>
    </div>
</div>

              
                
<div id="searchbox"></div>
                <article class="bd-article" role="main">
                  
  <p><img alt="Forecasting Demo 1: Baselines, Prophet, and NeuralProphet" src="https://raw.githubusercontent.com/VectorInstitute/forecasting-bootcamp/media-assets-do-not-merge/forecasting-demo-1.png?token=GHSAT0AAAAAABQMCWQFQHUMDN4MVB2LEQDUYQ7WXUQ" /></p>
<section class="tex2jax_ignore mathjax_ignore" id="baselines-prophet-and-neuralprophet">
<h1>Baselines, Prophet and NeuralProphet<a class="headerlink" href="#baselines-prophet-and-neuralprophet" title="Permalink to this heading">#</a></h1>
<p>This notebook is the first of a series that introduces the application of popular, recently developed time series forecasting methods. In particular, we emphasize the use of consistent evaluation metrics and analysis across all models and model configurations.</p>
<p>Use these notebooks as tools to explore the application of various forecasting methods to multivariate time series datasets, and to inspire an experimental approach for comparing multiple models and model configurations.</p>
<p>This notebook explores the application of <strong>Prophet</strong> and <strong>NeuralProphet</strong> to exchange rate forecasting, as well as two baseline methods using <strong>sktime</strong>.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="k">if</span> <span class="s1">&#39;google.colab&#39;</span> <span class="ow">in</span> <span class="nb">str</span><span class="p">(</span><span class="n">get_ipython</span><span class="p">()):</span>
    <span class="o">!</span>pip<span class="w"> </span>install<span class="w"> </span>prophet
    <span class="o">!</span>pip<span class="w"> </span>install<span class="w"> </span>git+https://github.com/ourownstory/neural_prophet.git<span class="w"> </span>#<span class="w"> </span>may<span class="w"> </span>take<span class="w"> </span>a<span class="w"> </span><span class="k">while</span>
    <span class="c1">#!pip install neuralprophet # much faster, but may not have the latest upgrades/bugfixes</span>
    <span class="o">!</span>pip<span class="w"> </span>install<span class="w"> </span>sktime

<span class="kn">import</span> <span class="nn">matplotlib.pyplot</span> <span class="k">as</span> <span class="nn">plt</span>
<span class="kn">import</span> <span class="nn">seaborn</span> <span class="k">as</span> <span class="nn">sns</span>
<span class="kn">import</span> <span class="nn">numpy</span> <span class="k">as</span> <span class="nn">np</span>
<span class="kn">import</span> <span class="nn">pandas</span> <span class="k">as</span> <span class="nn">pd</span>
<span class="kn">from</span> <span class="nn">sktime.forecasting.naive</span> <span class="kn">import</span> <span class="n">NaiveForecaster</span>
<span class="kn">from</span> <span class="nn">prophet</span> <span class="kn">import</span> <span class="n">Prophet</span>
<span class="kn">from</span> <span class="nn">neuralprophet</span> <span class="kn">import</span> <span class="n">NeuralProphet</span>
</pre></div>
</div>
</div>
</div>
<section id="data-loading">
<h2>Data Loading<a class="headerlink" href="#data-loading" title="Permalink to this heading">#</a></h2>
<section id="load-exchange-rate-data-file">
<h3>Load exchange rate data file<a class="headerlink" href="#load-exchange-rate-data-file" title="Permalink to this heading">#</a></h3>
<p>The used dataset includes daily exchange rates between CAD and 12 other currencies between 2007 and 2017.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="k">if</span> <span class="s1">&#39;google.colab&#39;</span> <span class="ow">in</span> <span class="nb">str</span><span class="p">(</span><span class="n">get_ipython</span><span class="p">()):</span>
    <span class="kn">from</span> <span class="nn">google.colab</span> <span class="kn">import</span> <span class="n">drive</span>
    <span class="n">drive</span><span class="o">.</span><span class="n">mount</span><span class="p">(</span><span class="s1">&#39;/content/drive&#39;</span><span class="p">)</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># your Google Drive path may also begin with /content/drive/MyDrive/</span>
<span class="n">data_filename</span> <span class="o">=</span> <span class="s2">&quot;/ssd003/projects/forecasting_bootcamp/bootcamp_datasets/boc_exchange/dataset.csv&quot;</span>
<span class="n">data_df</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">read_csv</span><span class="p">(</span><span class="n">data_filename</span><span class="p">,</span> <span class="n">index_col</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
<span class="n">data_df</span><span class="o">.</span><span class="n">index</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">to_datetime</span><span class="p">(</span><span class="n">data_df</span><span class="o">.</span><span class="n">index</span><span class="p">)</span>
<span class="n">data_df</span> <span class="o">=</span> <span class="n">data_df</span><span class="o">.</span><span class="n">reset_index</span><span class="p">()</span><span class="o">.</span><span class="n">rename</span><span class="p">({</span><span class="s1">&#39;index&#39;</span><span class="p">:</span><span class="s1">&#39;date&#39;</span><span class="p">},</span> <span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
<span class="n">data_df</span>
</pre></div>
</div>
</div>
</div>
</section>
<section id="split-data-according-to-use-case">
<h3>Split data according to use case<a class="headerlink" href="#split-data-according-to-use-case" title="Permalink to this heading">#</a></h3>
<p>For simplicity, this notebook uses a conventional training and testing split over the dataset. Other notebooks will give examples of rolling cross validation using multiple validation periods given by a set of cutoff dates.</p>
<p>The purpose of this notebook is to explore a simpler problem formulation using multiple models. The experiments and analysis can be easily adapted for rolling cross validation.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">lag_time</span> <span class="o">=</span> <span class="mi">90</span>
<span class="n">lead_time</span> <span class="o">=</span> <span class="mi">60</span>

<span class="n">train_size</span> <span class="o">=</span> <span class="mf">0.8</span>

<span class="n">train_df</span> <span class="o">=</span> <span class="n">data_df</span><span class="o">.</span><span class="n">iloc</span><span class="p">[:</span><span class="nb">int</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">data_df</span><span class="p">)</span><span class="o">*</span><span class="n">train_size</span><span class="p">)]</span>
<span class="n">test_df</span> <span class="o">=</span> <span class="n">data_df</span><span class="o">.</span><span class="n">iloc</span><span class="p">[</span><span class="nb">int</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">data_df</span><span class="p">)</span><span class="o">*</span><span class="n">train_size</span><span class="p">):]</span>
</pre></div>
</div>
</div>
</div>
<p>To ensure that we have enough data for testing, we need to withhold at least <code class="docutils literal notranslate"><span class="pre">lag_time</span> <span class="pre">+</span> <span class="pre">lead_time</span></code> observations from the dataset. Assuming we want to test a fitted model on all available examples in the test set, the number of testing examples can be computed as follows.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">n_test_cases</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">test_df</span><span class="p">)</span> <span class="o">-</span> <span class="n">lag_time</span> <span class="o">-</span> <span class="n">lead_time</span> <span class="o">+</span> <span class="mi">1</span>
<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;   Timesteps in test_df: </span><span class="si">{</span><span class="nb">len</span><span class="p">(</span><span class="n">test_df</span><span class="p">)</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Number of test examples: </span><span class="si">{</span><span class="n">n_test_cases</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
</pre></div>
</div>
</div>
</div>
</section>
<section id="iterating-over-test-examples">
<h3>Iterating over test examples<a class="headerlink" href="#iterating-over-test-examples" title="Permalink to this heading">#</a></h3>
<p>To help with iterating over valid pairs of input and target data, we define a PyTorch-like dataset class. In this notebook, we’ll use this primarily for iterating over test examples, since both Prophet and NeuralProphet impose their own, special formats for passing in training data.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="k">class</span> <span class="nc">ForecastingDataset</span><span class="p">:</span>

    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">data_df</span><span class="p">,</span> <span class="n">lag_time</span><span class="p">,</span> <span class="n">lead_time</span><span class="p">,</span> <span class="n">feature_columns</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">n_examples</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">data_df</span><span class="p">)</span> <span class="o">-</span> <span class="n">lag_time</span> <span class="o">-</span> <span class="n">lead_time</span> <span class="o">+</span> <span class="mi">1</span>
        <span class="k">assert</span> <span class="bp">self</span><span class="o">.</span><span class="n">n_examples</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">,</span> <span class="s2">&quot;Dataset must contain at least one example.&quot;</span>
        <span class="k">assert</span> <span class="s2">&quot;date&quot;</span> <span class="ow">in</span> <span class="n">data_df</span><span class="o">.</span><span class="n">columns</span> <span class="ow">or</span> <span class="s2">&quot;ds&quot;</span> <span class="ow">in</span> <span class="n">data_df</span><span class="o">.</span><span class="n">columns</span><span class="p">,</span> <span class="s2">&quot;Source DataFrame must contain a date/ds column.&quot;</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">df</span> <span class="o">=</span> <span class="n">data_df</span><span class="p">[</span><span class="n">feature_columns</span><span class="p">]</span>
        <span class="k">if</span> <span class="s1">&#39;date&#39;</span> <span class="ow">in</span> <span class="n">data_df</span><span class="o">.</span><span class="n">columns</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">dates</span> <span class="o">=</span> <span class="n">data_df</span><span class="o">.</span><span class="n">date</span>
        <span class="k">elif</span> <span class="s1">&#39;ds&#39;</span> <span class="ow">in</span> <span class="n">data_df</span><span class="o">.</span><span class="n">columns</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">dates</span> <span class="o">=</span> <span class="n">data_df</span><span class="o">.</span><span class="n">ds</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">lag_time</span> <span class="o">=</span> <span class="n">lag_time</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">lead_time</span> <span class="o">=</span> <span class="n">lead_time</span>

    <span class="k">def</span> <span class="fm">__len__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">n_examples</span>

    <span class="k">def</span> <span class="fm">__getitem__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">idx</span><span class="p">):</span>
        <span class="nb">input</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">df</span><span class="o">.</span><span class="n">iloc</span><span class="p">[</span><span class="n">idx</span><span class="p">:</span><span class="n">idx</span><span class="o">+</span><span class="n">lag_time</span><span class="p">]</span>
        <span class="n">output</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">df</span><span class="o">.</span><span class="n">iloc</span><span class="p">[</span><span class="n">idx</span><span class="o">+</span><span class="n">lag_time</span><span class="p">:</span><span class="n">idx</span><span class="o">+</span><span class="n">lag_time</span><span class="o">+</span><span class="n">lead_time</span><span class="p">]</span>
        <span class="n">input_dates</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">dates</span><span class="p">[</span><span class="n">idx</span><span class="p">:</span><span class="n">idx</span><span class="o">+</span><span class="n">lag_time</span><span class="p">]</span>
        <span class="n">output_dates</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">dates</span><span class="p">[</span><span class="n">idx</span><span class="o">+</span><span class="n">lag_time</span><span class="p">:</span><span class="n">idx</span><span class="o">+</span><span class="n">lag_time</span><span class="o">+</span><span class="n">lead_time</span><span class="p">]</span>
        <span class="k">return</span> <span class="nb">input</span><span class="p">,</span> <span class="n">output</span><span class="p">,</span> <span class="n">input_dates</span><span class="p">,</span> <span class="n">output_dates</span>
</pre></div>
</div>
</div>
</div>
<p>Next, we instantiate an indexable <code class="docutils literal notranslate"><span class="pre">test_dataset</span></code>.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">feature_columns</span> <span class="o">=</span> <span class="p">[</span><span class="n">col</span> <span class="k">for</span> <span class="n">col</span> <span class="ow">in</span> <span class="n">test_df</span> <span class="k">if</span> <span class="n">col</span><span class="o">.</span><span class="n">endswith</span><span class="p">(</span><span class="s2">&quot;_CLOSE&quot;</span><span class="p">)]</span>
<span class="n">test_dataset</span> <span class="o">=</span> <span class="n">ForecastingDataset</span><span class="p">(</span><span class="n">test_df</span><span class="p">,</span> <span class="n">lag_time</span><span class="p">,</span> <span class="n">lead_time</span><span class="p">,</span> <span class="n">feature_columns</span><span class="p">)</span>
</pre></div>
</div>
</div>
</div>
</section>
</section>
<section id="evaluation-metrics">
<h2>Evaluation Metrics<a class="headerlink" href="#evaluation-metrics" title="Permalink to this heading">#</a></h2>
<p>In order to objectively compare the performance of this and other models on out-of-sample forecasting performance, we will need to collect output in a consistent format and apply a suite of standard evaluation metrics:</p>
<ul class="simple">
<li><p>Mean Squared Error (MSE)</p></li>
<li><p>Root Mean Squared Error (RMSE)</p></li>
<li><p>Mean Absolute Error (MAE)</p></li>
<li><p>Mean Absolute Percentage Error (MAPE)</p></li>
</ul>
<p>See the article <a class="reference external" href="https://towardsdatascience.com/time-series-forecast-error-metrics-you-should-know-cc88b8c67f27">Time Series Forecast Error Metrics You Should Know</a> for an overview of these and other popular forecasting error metrics.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="kn">from</span> <span class="nn">sklearn.metrics</span> <span class="kn">import</span> <span class="n">mean_squared_error</span><span class="p">,</span> <span class="n">mean_absolute_error</span><span class="p">,</span> <span class="n">mean_absolute_percentage_error</span>

<span class="n">metrics</span> <span class="o">=</span> <span class="p">{</span>
    <span class="s1">&#39;mse&#39;</span><span class="p">:</span> <span class="n">mean_squared_error</span><span class="p">,</span>
    <span class="s1">&#39;rmse&#39;</span><span class="p">:</span> <span class="k">lambda</span> <span class="n">y_true</span><span class="p">,</span> <span class="n">y_pred</span><span class="p">:</span> <span class="n">np</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="n">mean_squared_error</span><span class="p">(</span><span class="n">y_true</span><span class="p">,</span> <span class="n">y_pred</span><span class="p">)),</span>
    <span class="s1">&#39;mae&#39;</span><span class="p">:</span> <span class="n">mean_absolute_error</span><span class="p">,</span>
    <span class="s1">&#39;mape&#39;</span><span class="p">:</span> <span class="n">mean_absolute_percentage_error</span>
<span class="p">}</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="k">def</span> <span class="nf">compute_error_statistics</span><span class="p">(</span><span class="n">error_metrics_dict</span><span class="p">,</span> <span class="n">exp_name</span><span class="p">):</span>
    <span class="k">return</span> <span class="p">{</span>
        <span class="s1">&#39;mean&#39;</span><span class="p">:</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">(</span><span class="n">error_metrics_dict</span><span class="p">)</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span><span class="o">.</span><span class="n">rename</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;</span><span class="si">{</span><span class="n">exp_name</span><span class="si">}</span><span class="s1">_mean_metrics&#39;</span><span class="p">),</span>
        <span class="s1">&#39;std&#39;</span><span class="p">:</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">(</span><span class="n">error_metrics_dict</span><span class="p">)</span><span class="o">.</span><span class="n">std</span><span class="p">(</span><span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span><span class="o">.</span><span class="n">rename</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;</span><span class="si">{</span><span class="n">exp_name</span><span class="si">}</span><span class="s1">_std_metrics&#39;</span><span class="p">),</span>
        <span class="s1">&#39;max&#39;</span><span class="p">:</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">(</span><span class="n">error_metrics_dict</span><span class="p">)</span><span class="o">.</span><span class="n">max</span><span class="p">(</span><span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span><span class="o">.</span><span class="n">rename</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;</span><span class="si">{</span><span class="n">exp_name</span><span class="si">}</span><span class="s1">_max_metrics&#39;</span><span class="p">),</span>
    <span class="p">}</span>
</pre></div>
</div>
</div>
</div>
</section>
<section id="baseline-forecasts">
<h2>Baseline Forecasts<a class="headerlink" href="#baseline-forecasts" title="Permalink to this heading">#</a></h2>
<p>Let’s begin our experiments by producing forecasts using naïve estimators. A common baseline is <em>persistence forecasting</em>, where the forecast is simply an extension of the last known observation of the time series. A second baseline is the <em>mean window forecast</em>, where we take the mean over a window of observations and use this value for forecasts. The following code produces and collects the baseline forecasts into lists.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">baseline_model_persistence</span> <span class="o">=</span> <span class="n">NaiveForecaster</span><span class="p">(</span><span class="n">strategy</span><span class="o">=</span><span class="s1">&#39;last&#39;</span><span class="p">)</span>
<span class="n">baseline_model_mean</span> <span class="o">=</span> <span class="n">NaiveForecaster</span><span class="p">(</span><span class="n">strategy</span><span class="o">=</span><span class="s1">&#39;mean&#39;</span><span class="p">,</span><span class="n">window_length</span><span class="o">=</span><span class="n">lag_time</span><span class="p">)</span>

<span class="n">forecasts_persistence</span> <span class="o">=</span> <span class="p">[]</span>
<span class="n">forecasts_mean</span> <span class="o">=</span> <span class="p">[]</span>

<span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">test_dataset</span><span class="p">)):</span>
    <span class="n">x</span><span class="p">,</span> <span class="n">y</span><span class="p">,</span> <span class="n">x_d</span><span class="p">,</span> <span class="n">y_d</span> <span class="o">=</span> <span class="n">test_dataset</span><span class="p">[</span><span class="n">i</span><span class="p">]</span>
    
    <span class="n">persistence_fc</span> <span class="o">=</span> <span class="n">baseline_model_persistence</span><span class="o">.</span><span class="n">fit_predict</span><span class="p">(</span><span class="n">x</span><span class="p">[</span><span class="s1">&#39;USD_CLOSE&#39;</span><span class="p">],</span> <span class="n">fh</span><span class="o">=</span><span class="nb">list</span><span class="p">(</span><span class="nb">range</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="n">lead_time</span><span class="o">+</span><span class="mi">1</span><span class="p">)))</span>
    <span class="n">persistence_fc</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">Series</span><span class="p">(</span><span class="n">persistence_fc</span><span class="o">.</span><span class="n">values</span><span class="p">,</span> <span class="n">index</span><span class="o">=</span><span class="n">y_d</span><span class="p">)</span>
    <span class="n">forecasts_persistence</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">persistence_fc</span><span class="p">)</span>

    <span class="n">mean_fc</span> <span class="o">=</span> <span class="n">baseline_model_mean</span><span class="o">.</span><span class="n">fit_predict</span><span class="p">(</span><span class="n">x</span><span class="p">[</span><span class="s1">&#39;USD_CLOSE&#39;</span><span class="p">],</span> <span class="n">fh</span><span class="o">=</span><span class="nb">list</span><span class="p">(</span><span class="nb">range</span><span class="p">(</span><span class="n">lead_time</span><span class="p">)))</span>
    <span class="n">mean_fc</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">Series</span><span class="p">(</span><span class="n">mean_fc</span><span class="o">.</span><span class="n">values</span><span class="p">,</span> <span class="n">index</span><span class="o">=</span><span class="n">y_d</span><span class="p">)</span>
    <span class="n">forecasts_mean</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">mean_fc</span><span class="p">)</span>

    <span class="nb">print</span><span class="p">(</span><span class="n">i</span><span class="p">,</span> <span class="n">end</span><span class="o">=</span><span class="s1">&#39;</span><span class="se">\r</span><span class="s1">&#39;</span><span class="p">)</span>
</pre></div>
</div>
</div>
</div>
<section id="compute-error-metrics-over-the-baseline-forecasts">
<h3>Compute error metrics over the baseline forecasts<a class="headerlink" href="#compute-error-metrics-over-the-baseline-forecasts" title="Permalink to this heading">#</a></h3>
<p>In this notebook, we want to compare the performance of experimental models (Prophet, NeuralProphet) compared to baselines (persistence and mean window extension). The following code applies each of the four evaluation metrics for every example in the test set.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="k">def</span> <span class="nf">compute_baseline_error_metrics</span><span class="p">(</span><span class="n">forecasts</span><span class="p">,</span> <span class="n">test_dataset</span><span class="p">):</span>

    <span class="n">errors</span> <span class="o">=</span> <span class="p">{</span><span class="n">metric_name</span><span class="p">:[]</span> <span class="k">for</span> <span class="n">metric_name</span> <span class="ow">in</span> <span class="n">metrics</span><span class="o">.</span><span class="n">keys</span><span class="p">()}</span>

    <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">forecasts</span><span class="p">)):</span>
        
        <span class="n">fc</span> <span class="o">=</span> <span class="n">forecasts</span><span class="p">[</span><span class="n">i</span><span class="p">]</span>
        <span class="n">x</span><span class="p">,</span> <span class="n">y</span><span class="p">,</span> <span class="n">x_d</span><span class="p">,</span> <span class="n">y_d</span> <span class="o">=</span> <span class="n">test_dataset</span><span class="p">[</span><span class="n">i</span><span class="p">]</span>
    
        <span class="k">for</span> <span class="n">metric_name</span><span class="p">,</span> <span class="n">metric_fn</span> <span class="ow">in</span> <span class="n">metrics</span><span class="o">.</span><span class="n">items</span><span class="p">():</span> 
                <span class="n">errors</span><span class="p">[</span><span class="n">metric_name</span><span class="p">]</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">metric_fn</span><span class="p">(</span><span class="n">y_true</span><span class="o">=</span><span class="n">y</span><span class="p">[</span><span class="s1">&#39;USD_CLOSE&#39;</span><span class="p">],</span> <span class="n">y_pred</span><span class="o">=</span><span class="n">fc</span><span class="p">))</span>

    <span class="k">return</span> <span class="n">errors</span><span class="p">,</span> <span class="n">forecasts</span>

<span class="n">persistence_errors</span><span class="p">,</span> <span class="n">_</span> <span class="o">=</span> <span class="n">compute_baseline_error_metrics</span><span class="p">(</span><span class="n">forecasts_persistence</span><span class="p">,</span> <span class="n">test_dataset</span><span class="p">)</span>
<span class="n">mean_errors</span><span class="p">,</span> <span class="n">_</span> <span class="o">=</span> <span class="n">compute_baseline_error_metrics</span><span class="p">(</span><span class="n">forecasts_mean</span><span class="p">,</span> <span class="n">test_dataset</span><span class="p">)</span>
</pre></div>
</div>
</div>
</div>
<p>The following code uses the function <code class="docutils literal notranslate"><span class="pre">compute_error_statistics</span></code> to reduce the mean evaluation metrics over the entire test set to three statistics (mean, standard deviation, and max).</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">persistence_stats</span> <span class="o">=</span> <span class="n">compute_error_statistics</span><span class="p">(</span><span class="n">persistence_errors</span><span class="p">,</span> <span class="s1">&#39;persistence&#39;</span><span class="p">)</span>
<span class="n">persistence_stats</span><span class="p">[</span><span class="s1">&#39;mean&#39;</span><span class="p">]</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">mean_window_stats</span> <span class="o">=</span> <span class="n">compute_error_statistics</span><span class="p">(</span><span class="n">mean_errors</span><span class="p">,</span> <span class="s1">&#39;mean_window&#39;</span><span class="p">)</span>
<span class="n">mean_window_stats</span><span class="p">[</span><span class="s1">&#39;mean&#39;</span><span class="p">]</span>
</pre></div>
</div>
</div>
</div>
<p>We now collect the mean evaluation statistics for each metric into a DataFrame so that we can later compare these to experimental models.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">results_df</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">(</span><span class="n">persistence_stats</span><span class="p">[</span><span class="s1">&#39;mean&#39;</span><span class="p">])</span><span class="o">.</span><span class="n">T</span>
<span class="n">results_df</span> <span class="o">=</span> <span class="n">results_df</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">mean_window_stats</span><span class="p">[</span><span class="s1">&#39;mean&#39;</span><span class="p">])</span>
<span class="n">results_df</span>
</pre></div>
</div>
</div>
</div>
</section>
<section id="visualizing-forecasts-over-the-test-set">
<h3>Visualizing forecasts over the test set<a class="headerlink" href="#visualizing-forecasts-over-the-test-set" title="Permalink to this heading">#</a></h3>
<p>For each example in the test set, we have produced a forecast between <code class="docutils literal notranslate"><span class="pre">1</span></code> and <code class="docutils literal notranslate"><span class="pre">lead_time</span></code> days into the future. As we will see later, this is difficult to visualize over the whole test set. Instead, we can visualize the value of each forecast at a single time step into the future. The code below visualizes the baseline forecasts at the maximum lead time. As we can see, the persistence forecast is exactly the ground truth shifted <code class="docutils literal notranslate"><span class="pre">lead_time</span></code> days into the future. In the context of exchange rate forecasting, this baseline may be difficult to beat.</p>
<section id="persistence-forecasts-at-max-lead-time">
<h4>Persistence Forecasts At Max Lead Time<a class="headerlink" href="#persistence-forecasts-at-max-lead-time" title="Permalink to this heading">#</a></h4>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">max_fcs</span> <span class="o">=</span> <span class="p">[{</span><span class="s1">&#39;date&#39;</span><span class="p">:</span> <span class="n">fc</span><span class="o">.</span><span class="n">index</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">:][</span><span class="mi">0</span><span class="p">],</span> <span class="s1">&#39;yhat&#39;</span><span class="p">:</span><span class="n">fc</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">:][</span><span class="mi">0</span><span class="p">]}</span> <span class="k">for</span> <span class="n">fc</span> <span class="ow">in</span> <span class="n">forecasts_persistence</span><span class="p">]</span>
<span class="n">max_fcs</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">(</span><span class="n">max_fcs</span><span class="p">)</span>

<span class="n">plt</span><span class="o">.</span><span class="n">figure</span><span class="p">(</span><span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="mi">12</span><span class="p">,</span><span class="mi">3</span><span class="p">))</span>
<span class="n">plt</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">test_df</span><span class="o">.</span><span class="n">date</span><span class="p">,</span> <span class="n">test_df</span><span class="p">[</span><span class="s1">&#39;USD_CLOSE&#39;</span><span class="p">],</span> <span class="n">color</span><span class="o">=</span><span class="s1">&#39;blue&#39;</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="s1">&#39;ground truth&#39;</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">max_fcs</span><span class="o">.</span><span class="n">date</span><span class="p">,</span> <span class="n">max_fcs</span><span class="o">.</span><span class="n">yhat</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="s1">&#39;red&#39;</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="s1">&#39;forecast&#39;</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">title</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Forecasts at max lead time (</span><span class="si">{</span><span class="n">lead_time</span><span class="si">}</span><span class="s2"> samples) - Persistence&quot;</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">legend</span><span class="p">(</span><span class="n">loc</span><span class="o">=</span><span class="s1">&#39;upper right&#39;</span><span class="p">)</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># Plot ground truth</span>
<span class="n">plt</span><span class="o">.</span><span class="n">figure</span><span class="p">(</span><span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="mi">12</span><span class="p">,</span><span class="mi">3</span><span class="p">))</span>
<span class="n">ground_truth</span> <span class="o">=</span> <span class="n">test_df</span><span class="p">[[</span><span class="s1">&#39;date&#39;</span><span class="p">,</span> <span class="s1">&#39;USD_CLOSE&#39;</span><span class="p">]]</span>
<span class="n">plt</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">ground_truth</span><span class="o">.</span><span class="n">date</span><span class="p">,</span> <span class="n">ground_truth</span><span class="p">[</span><span class="s1">&#39;USD_CLOSE&#39;</span><span class="p">],</span> <span class="n">label</span><span class="o">=</span><span class="s1">&#39;ground truth&#39;</span><span class="p">)</span>

<span class="c1"># Plot example single forecast</span>
<span class="n">plt</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">forecasts_persistence</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">],</span> <span class="n">label</span><span class="o">=</span><span class="s1">&#39;forecast&#39;</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">legend</span><span class="p">()</span>
</pre></div>
</div>
</div>
</div>
</section>
<section id="mean-window-forecasts-at-max-lead-time">
<h4>Mean Window Forecasts At Max Lead Time<a class="headerlink" href="#mean-window-forecasts-at-max-lead-time" title="Permalink to this heading">#</a></h4>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">max_fcs</span> <span class="o">=</span> <span class="p">[{</span><span class="s1">&#39;date&#39;</span><span class="p">:</span> <span class="n">fc</span><span class="o">.</span><span class="n">index</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">:][</span><span class="mi">0</span><span class="p">],</span> <span class="s1">&#39;yhat&#39;</span><span class="p">:</span><span class="n">fc</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">:][</span><span class="mi">0</span><span class="p">]}</span> <span class="k">for</span> <span class="n">fc</span> <span class="ow">in</span> <span class="n">forecasts_mean</span><span class="p">]</span>
<span class="n">max_fcs</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">(</span><span class="n">max_fcs</span><span class="p">)</span>

<span class="n">plt</span><span class="o">.</span><span class="n">figure</span><span class="p">(</span><span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="mi">12</span><span class="p">,</span><span class="mi">3</span><span class="p">))</span>
<span class="n">plt</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">test_df</span><span class="o">.</span><span class="n">date</span><span class="p">,</span> <span class="n">test_df</span><span class="p">[</span><span class="s1">&#39;USD_CLOSE&#39;</span><span class="p">],</span> <span class="n">color</span><span class="o">=</span><span class="s1">&#39;blue&#39;</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="s1">&#39;ground truth&#39;</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">max_fcs</span><span class="o">.</span><span class="n">date</span><span class="p">,</span> <span class="n">max_fcs</span><span class="o">.</span><span class="n">yhat</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="s1">&#39;red&#39;</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="s1">&#39;forecast&#39;</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">title</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Forecasts at max lead time (</span><span class="si">{</span><span class="n">lead_time</span><span class="si">}</span><span class="s2"> samples) - Mean Window&quot;</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">legend</span><span class="p">(</span><span class="n">loc</span><span class="o">=</span><span class="s1">&#39;upper right&#39;</span><span class="p">)</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># Plot ground truth</span>
<span class="n">plt</span><span class="o">.</span><span class="n">figure</span><span class="p">(</span><span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="mi">12</span><span class="p">,</span><span class="mi">3</span><span class="p">))</span>
<span class="n">ground_truth</span> <span class="o">=</span> <span class="n">test_df</span><span class="p">[[</span><span class="s1">&#39;date&#39;</span><span class="p">,</span> <span class="s1">&#39;USD_CLOSE&#39;</span><span class="p">]]</span>
<span class="n">plt</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">ground_truth</span><span class="o">.</span><span class="n">date</span><span class="p">,</span> <span class="n">ground_truth</span><span class="p">[</span><span class="s1">&#39;USD_CLOSE&#39;</span><span class="p">],</span> <span class="n">label</span><span class="o">=</span><span class="s1">&#39;ground truth&#39;</span><span class="p">)</span>

<span class="c1"># Plot example single forecast</span>
<span class="n">plt</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">forecasts_mean</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">],</span> <span class="n">label</span><span class="o">=</span><span class="s1">&#39;forecast&#39;</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">legend</span><span class="p">()</span>
</pre></div>
</div>
</div>
</div>
</section>
</section>
</section>
<section id="prophet">
<h2>Prophet<a class="headerlink" href="#prophet" title="Permalink to this heading">#</a></h2>
<p>Univariate forecasting that supports additional <em>future</em> regressors. Prophet does not support the inclusion of <em>lagged regressors</em>, i.e. it does not support the use of historical values of multiple series to predict a single target series. We include it as a baseline because it is popular, lightweight, interpretable, and performs very well in some domains.</p>
<p>Prophet is based on a Generalized Additive Model (GAM):</p>
<p><span class="math notranslate nohighlight">\( y(t) = g(t) + s(t) + h(t) + \epsilon_t\)</span></p>
<p>where <span class="math notranslate nohighlight">\(y(t)\)</span> is the target series, <span class="math notranslate nohighlight">\(g(t)\)</span> is the trend function, <span class="math notranslate nohighlight">\(s(t)\)</span> is the seasonality or periodic function, <span class="math notranslate nohighlight">\(h(t)\)</span> is a function reflecting holidays or other irregular events, and <span class="math notranslate nohighlight">\(\epsilon_t\)</span> is an error term that is assumed to be normally distributed.</p>
<p>Despite being formulated as an additive model, multiplicative interaction between seasonality and trend components is supported (using a log transform). In the implementation, this is easily configurable using a constructor parameter. See the <a class="reference external" href="https://facebook.github.io/prophet/docs/multiplicative_seasonality.html">documentation</a> for more details.</p>
<section id="data-preparation">
<h3>Data Preparation<a class="headerlink" href="#data-preparation" title="Permalink to this heading">#</a></h3>
<p>Prophet, like most forecasting packages, imposes its own, specific format for input data. It expects inputs in the form of a Pandas DataFrame with two columns, <code class="docutils literal notranslate"><span class="pre">ds</span></code> and <code class="docutils literal notranslate"><span class="pre">y</span></code>, which correspond to Pandas-formatted timestamps and the target time series, respectively.</p>
<p>In this example, we create a Prophet DataFrame by selecting the columns <code class="docutils literal notranslate"><span class="pre">date</span></code> and <code class="docutils literal notranslate"><span class="pre">USD_CLOSE</span></code> from the Bank of Canada exchange rate dataset. We then rename those columns to <code class="docutils literal notranslate"><span class="pre">ds</span></code> and <code class="docutils literal notranslate"><span class="pre">y</span></code>, respectively.</p>
<p>Note that the <code class="docutils literal notranslate"><span class="pre">ds</span></code> column is already correctly formatted using the Pandas datetime format, since we converted it immediately after loading the data. When reading CSVs, always be sure to check that datestamps are properly formatted.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">prophet_model_df</span> <span class="o">=</span> <span class="n">train_df</span><span class="p">[[</span><span class="s1">&#39;date&#39;</span><span class="p">,</span> <span class="s1">&#39;USD_CLOSE&#39;</span><span class="p">]]</span>
<span class="n">prophet_model_df</span> <span class="o">=</span> <span class="n">train_df</span><span class="o">.</span><span class="n">rename</span><span class="p">({</span><span class="s1">&#39;date&#39;</span><span class="p">:</span><span class="s1">&#39;ds&#39;</span><span class="p">,</span> <span class="s1">&#39;USD_CLOSE&#39;</span><span class="p">:</span><span class="s1">&#39;y&#39;</span><span class="p">},</span> <span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
<span class="n">prophet_model_df</span> <span class="o">=</span> <span class="n">prophet_model_df</span><span class="p">[[</span><span class="s1">&#39;ds&#39;</span><span class="p">,</span> <span class="s1">&#39;y&#39;</span><span class="p">]]</span>
<span class="n">prophet_model_df</span>
</pre></div>
</div>
</div>
</div>
</section>
<section id="model-initialization-and-fitting">
<h3>Model Initialization and Fitting<a class="headerlink" href="#model-initialization-and-fitting" title="Permalink to this heading">#</a></h3>
<p>For our baseline model, we fit Prophet using its default configuration.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">model</span> <span class="o">=</span> <span class="n">Prophet</span><span class="p">()</span>
<span class="n">model</span> <span class="o">=</span> <span class="n">model</span><span class="o">.</span><span class="n">fit</span><span class="p">(</span><span class="n">prophet_model_df</span><span class="p">)</span>
</pre></div>
</div>
</div>
</div>
</section>
<section id="produce-forecasts">
<h3>Produce Forecasts<a class="headerlink" href="#produce-forecasts" title="Permalink to this heading">#</a></h3>
<p>To produce a forecast using a fitted Prophet model, we need to pass it a dataframe with the desired timestamps in a column named <code class="docutils literal notranslate"><span class="pre">ds</span></code>. In the example below, we use the fitted model object to produce a dataframe <code class="docutils literal notranslate"><span class="pre">future</span></code> with dates that extend <code class="docutils literal notranslate"><span class="pre">len(test_df)</span></code> days beyond the training dates. Passing <code class="docutils literal notranslate"><span class="pre">future</span></code> to the fitted model’s <code class="docutils literal notranslate"><span class="pre">predict</span></code> function will return a dataframe populated with a detailed forecast, including model component values and confidence ranges.</p>
<p>Notice here that we are asking Prophet to produce a single forecast for the entire test period. We are doing this because Prophet does not support inference using fixed-sized inputs in the same way that every other technique considered in our bootcamp does.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">future</span> <span class="o">=</span> <span class="n">model</span><span class="o">.</span><span class="n">make_future_dataframe</span><span class="p">(</span><span class="n">periods</span><span class="o">=</span><span class="nb">len</span><span class="p">(</span><span class="n">test_df</span><span class="p">))</span>
<span class="n">forecast</span> <span class="o">=</span> <span class="n">model</span><span class="o">.</span><span class="n">predict</span><span class="p">(</span><span class="n">future</span><span class="p">)</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">forecast</span><span class="o">.</span><span class="n">tail</span><span class="p">(</span><span class="mi">5</span><span class="p">)</span>
</pre></div>
</div>
</div>
</div>
</section>
<section id="plotting-prophet-forecasts">
<h3>Plotting Prophet Forecasts<a class="headerlink" href="#plotting-prophet-forecasts" title="Permalink to this heading">#</a></h3>
<p>The following code visualizes the application of the fitted Prophet model to both in-sample (training) and out-of-sample (testing) data. Visualization and evaluation of forecasting models using out-of-sample data is crucial for estimating future performance.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">fig</span><span class="p">,</span> <span class="n">ax</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">subplots</span><span class="p">(</span><span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="mi">15</span><span class="p">,</span> <span class="mi">6</span><span class="p">))</span>

<span class="n">ax</span><span class="o">.</span><span class="n">fill_between</span><span class="p">(</span><span class="n">forecast</span><span class="o">.</span><span class="n">ds</span><span class="o">.</span><span class="n">iloc</span><span class="p">[:</span><span class="o">-</span><span class="nb">len</span><span class="p">(</span><span class="n">test_df</span><span class="p">)],</span> 
    <span class="n">forecast</span><span class="o">.</span><span class="n">yhat_lower</span><span class="o">.</span><span class="n">iloc</span><span class="p">[:</span><span class="o">-</span><span class="nb">len</span><span class="p">(</span><span class="n">test_df</span><span class="p">)],</span> 
    <span class="n">forecast</span><span class="o">.</span><span class="n">yhat_upper</span><span class="o">.</span><span class="n">iloc</span><span class="p">[:</span><span class="o">-</span><span class="nb">len</span><span class="p">(</span><span class="n">test_df</span><span class="p">)],</span>
    <span class="n">color</span><span class="o">=</span><span class="s1">&#39;blue&#39;</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="s1">&#39;In-Sample confidence interval (80%)&#39;</span><span class="p">,</span> <span class="n">alpha</span><span class="o">=</span><span class="mf">0.15</span><span class="p">)</span>

<span class="n">ax</span><span class="o">.</span><span class="n">fill_between</span><span class="p">(</span><span class="n">forecast</span><span class="o">.</span><span class="n">ds</span><span class="o">.</span><span class="n">iloc</span><span class="p">[</span><span class="o">-</span><span class="nb">len</span><span class="p">(</span><span class="n">test_df</span><span class="p">):],</span> 
    <span class="n">forecast</span><span class="o">.</span><span class="n">yhat_lower</span><span class="o">.</span><span class="n">iloc</span><span class="p">[</span><span class="o">-</span><span class="nb">len</span><span class="p">(</span><span class="n">test_df</span><span class="p">):],</span> 
    <span class="n">forecast</span><span class="o">.</span><span class="n">yhat_upper</span><span class="o">.</span><span class="n">iloc</span><span class="p">[</span><span class="o">-</span><span class="nb">len</span><span class="p">(</span><span class="n">test_df</span><span class="p">):],</span>
    <span class="n">color</span><span class="o">=</span><span class="s1">&#39;red&#39;</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="s1">&#39;Out-of-Sample confidence interval (80%)&#39;</span><span class="p">,</span> <span class="n">alpha</span><span class="o">=</span><span class="mf">0.1</span><span class="p">)</span>

<span class="n">ax</span><span class="o">.</span><span class="n">scatter</span><span class="p">(</span><span class="n">prophet_model_df</span><span class="o">.</span><span class="n">ds</span><span class="p">,</span> <span class="n">prophet_model_df</span><span class="p">[</span><span class="s1">&#39;y&#39;</span><span class="p">],</span> <span class="n">color</span><span class="o">=</span><span class="s1">&#39;slategrey&#39;</span><span class="p">,</span> <span class="n">s</span><span class="o">=</span><span class="mi">3</span><span class="p">,</span> <span class="n">linewidths</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="s1">&#39;Train Samples&#39;</span><span class="p">)</span>
<span class="n">ax</span><span class="o">.</span><span class="n">scatter</span><span class="p">(</span><span class="n">test_df</span><span class="o">.</span><span class="n">date</span><span class="p">,</span> <span class="n">test_df</span><span class="p">[</span><span class="s1">&#39;USD_CLOSE&#39;</span><span class="p">],</span> <span class="n">color</span><span class="o">=</span><span class="s1">&#39;salmon&#39;</span><span class="p">,</span> <span class="n">s</span><span class="o">=</span><span class="mi">3</span><span class="p">,</span> <span class="n">linewidths</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="s1">&#39;Test Samples&#39;</span><span class="p">)</span>

<span class="n">ax</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">forecast</span><span class="o">.</span><span class="n">ds</span><span class="o">.</span><span class="n">iloc</span><span class="p">[:</span><span class="o">-</span><span class="nb">len</span><span class="p">(</span><span class="n">test_df</span><span class="p">)],</span> 
        <span class="n">forecast</span><span class="o">.</span><span class="n">yhat</span><span class="o">.</span><span class="n">iloc</span><span class="p">[:</span><span class="o">-</span><span class="nb">len</span><span class="p">(</span><span class="n">test_df</span><span class="p">)],</span> <span class="n">color</span><span class="o">=</span><span class="s1">&#39;blue&#39;</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="s1">&#39;In-Sample Forecast&#39;</span><span class="p">)</span>

<span class="n">ax</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">forecast</span><span class="o">.</span><span class="n">ds</span><span class="o">.</span><span class="n">iloc</span><span class="p">[</span><span class="o">-</span><span class="nb">len</span><span class="p">(</span><span class="n">test_df</span><span class="p">):],</span> <span class="n">forecast</span><span class="o">.</span><span class="n">yhat</span><span class="o">.</span><span class="n">iloc</span><span class="p">[</span><span class="o">-</span><span class="nb">len</span><span class="p">(</span><span class="n">test_df</span><span class="p">):],</span> 
        <span class="n">color</span><span class="o">=</span><span class="s1">&#39;red&#39;</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="s1">&#39;Out-of-Sample Forecast&#39;</span><span class="p">)</span>

<span class="n">ax</span><span class="o">.</span><span class="n">legend</span><span class="p">(</span><span class="n">loc</span><span class="o">=</span><span class="s1">&#39;upper left&#39;</span><span class="p">)</span>
<span class="n">ax</span><span class="o">.</span><span class="n">grid</span><span class="p">(</span><span class="n">axis</span><span class="o">=</span><span class="s1">&#39;y&#39;</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">show</span><span class="p">()</span>
</pre></div>
</div>
</div>
</div>
</section>
<section id="prophet-forecasts-at-max-lead-time">
<h3>Prophet Forecasts At Max Lead Time<a class="headerlink" href="#prophet-forecasts-at-max-lead-time" title="Permalink to this heading">#</a></h3>
<p>As we did with the baseline methods, let’s visualize Prophet’s forecasts at maximum lead time.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># We can use our ForecastingDataset class to help with formatting Prophet&#39;s output.</span>
<span class="n">forecast_eval_dataset</span> <span class="o">=</span> <span class="n">ForecastingDataset</span><span class="p">(</span><span class="n">forecast</span><span class="o">.</span><span class="n">iloc</span><span class="p">[</span><span class="o">-</span><span class="nb">len</span><span class="p">(</span><span class="n">test_df</span><span class="p">):],</span> <span class="n">lag_time</span><span class="p">,</span> <span class="n">lead_time</span><span class="p">,</span> <span class="p">[</span><span class="s1">&#39;yhat&#39;</span><span class="p">])</span>

<span class="n">fig</span><span class="p">,</span> <span class="n">ax</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">subplots</span><span class="p">(</span><span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="mi">9</span><span class="p">,</span><span class="mi">4</span><span class="p">))</span>

<span class="n">forecasts_at_max_lead</span> <span class="o">=</span> <span class="p">[]</span>
<span class="n">dates_at_max_lead</span> <span class="o">=</span> <span class="p">[]</span>

<span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">forecast_eval_dataset</span><span class="p">)):</span>
    <span class="n">x</span><span class="p">,</span> <span class="n">y</span><span class="p">,</span> <span class="n">x_d</span><span class="p">,</span> <span class="n">y_d</span> <span class="o">=</span> <span class="n">forecast_eval_dataset</span><span class="p">[</span><span class="n">i</span><span class="p">]</span>
    <span class="n">x_gt</span><span class="p">,</span> <span class="n">y_gt</span><span class="p">,</span> <span class="n">x_gt_d</span><span class="p">,</span> <span class="n">y_gt_d</span> <span class="o">=</span> <span class="n">test_dataset</span><span class="p">[</span><span class="n">i</span><span class="p">]</span>

    <span class="n">forecasts_at_max_lead</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">y</span><span class="o">.</span><span class="n">values</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">])</span>
    <span class="n">dates_at_max_lead</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">y_d</span><span class="o">.</span><span class="n">values</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">])</span>

<span class="n">ax</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">dates_at_max_lead</span><span class="p">,</span> <span class="n">forecasts_at_max_lead</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="s1">&#39;red&#39;</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="s1">&#39;forecast&#39;</span><span class="p">)</span>
<span class="n">ax</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">test_df</span><span class="o">.</span><span class="n">date</span><span class="p">,</span> <span class="n">test_df</span><span class="p">[</span><span class="s1">&#39;USD_CLOSE&#39;</span><span class="p">],</span> <span class="n">color</span><span class="o">=</span><span class="s1">&#39;blue&#39;</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="s1">&#39;ground truth&#39;</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">legend</span><span class="p">()</span>
<span class="n">plt</span><span class="o">.</span><span class="n">title</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Forecasts at max lead time (</span><span class="si">{</span><span class="n">lead_time</span><span class="si">}</span><span class="s2"> samples) - Prophet&quot;</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">show</span><span class="p">()</span>
</pre></div>
</div>
</div>
</div>
<p>With the help of the ForecastingDataset class defined earlier, iterate over each forecast and ground truth pair, and compute and collect multiple evaluation metrics as defined in the previous cell.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="k">def</span> <span class="nf">compute_error_metrics</span><span class="p">(</span><span class="n">ground_truth_dataset</span><span class="p">,</span> <span class="n">forecast_dataset</span><span class="p">):</span>
        
    <span class="n">errors</span> <span class="o">=</span> <span class="p">{</span><span class="n">metric_name</span><span class="p">:[]</span> <span class="k">for</span> <span class="n">metric_name</span> <span class="ow">in</span> <span class="n">metrics</span><span class="o">.</span><span class="n">keys</span><span class="p">()}</span>

    <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">forecast_dataset</span><span class="p">)):</span>
        <span class="n">x</span><span class="p">,</span> <span class="n">y</span><span class="p">,</span> <span class="n">x_d</span><span class="p">,</span> <span class="n">y_d</span> <span class="o">=</span> <span class="n">forecast_dataset</span><span class="p">[</span><span class="n">i</span><span class="p">]</span>
        <span class="n">x_gt</span><span class="p">,</span> <span class="n">y_gt</span><span class="p">,</span> <span class="n">x_gt_d</span><span class="p">,</span> <span class="n">y_gt_d</span> <span class="o">=</span> <span class="n">ground_truth_dataset</span><span class="p">[</span><span class="n">i</span><span class="p">]</span>
        <span class="k">for</span> <span class="n">metric_name</span><span class="p">,</span> <span class="n">metric_fn</span> <span class="ow">in</span> <span class="n">metrics</span><span class="o">.</span><span class="n">items</span><span class="p">():</span> 
            <span class="n">errors</span><span class="p">[</span><span class="n">metric_name</span><span class="p">]</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">metric_fn</span><span class="p">(</span><span class="n">y_true</span><span class="o">=</span><span class="n">y_gt</span><span class="p">[</span><span class="s1">&#39;USD_CLOSE&#39;</span><span class="p">],</span> <span class="n">y_pred</span><span class="o">=</span><span class="n">y</span><span class="p">))</span>
    
    <span class="k">return</span> <span class="n">errors</span>

<span class="n">error_metrics</span> <span class="o">=</span> <span class="n">compute_error_metrics</span><span class="p">(</span><span class="n">test_dataset</span><span class="p">,</span> <span class="n">forecast_eval_dataset</span><span class="p">)</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">prophet_stats</span> <span class="o">=</span> <span class="n">compute_error_statistics</span><span class="p">(</span><span class="n">error_metrics</span><span class="p">,</span> <span class="s1">&#39;prophet&#39;</span><span class="p">)</span>
<span class="n">prophet_stats</span><span class="p">[</span><span class="s1">&#39;mean&#39;</span><span class="p">]</span>
</pre></div>
</div>
</div>
</div>
<p>Let’s now collect the mean evaluation metrics into a new DataFrame that we will use for comparative evalution against other models’ forecasts.</p>
<p>Please note that the comparison is not completely fair - Prophet has to predict 672 steps into the future at once, whereas our baselines only have to predict the next 60 days.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">results_df</span> <span class="o">=</span> <span class="n">results_df</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">prophet_stats</span><span class="p">[</span><span class="s1">&#39;mean&#39;</span><span class="p">])</span>
<span class="n">results_df</span><span class="o">.</span><span class="n">sort_values</span><span class="p">(</span><span class="s1">&#39;mae&#39;</span><span class="p">)</span>
</pre></div>
</div>
</div>
</div>
</section>
</section>
<section id="neuralprophet">
<h2>NeuralProphet<a class="headerlink" href="#neuralprophet" title="Permalink to this heading">#</a></h2>
<p>Let’s proceed to explore the <a class="reference external" href="https://neuralprophet.com/html/index.html">NeuralProphet</a> model. Please review the following resources to learn more:</p>
<ul class="simple">
<li><p><a class="reference external" href="https://arxiv.org/abs/2111.15397">Paper</a></p></li>
<li><p><a class="reference external" href="https://neuralprophet.com/html/contents.html">Documentation</a></p></li>
<li><p><a class="reference external" href="https://github.com/ourownstory/neural_prophet">GitHub</a></p></li>
</ul>
<p>In the words of its developers, NeuralProphet is “<em>based on neural networks, inspired by Facebook Prophet and AR-Net, built on PyTorch</em>”. A very important differentiating feature is that NeuralProphet conveniently supports <em>lagged regressors</em>. In the context of this running example, NeuralProphet supports the use of multiple other currencies’ time series. With this expanded flexibility, however, the model is more complex, with a greater number of design choices and hyperparameters to consider.</p>
<p>The official <a class="reference external" href="https://neuralprophet.com/html/lagged_covariates_energy_ercot.html">documentation on lagged regressors (lagged covariates)</a> gives several examples for configuring NeuralProphet models to use lagged regressors, but commentary and suggestions on best practices are largely absent.</p>
<p>In the following code, we will consider a small number of NeuralProphet model configurations applied to the same forecasting task from above. Importantly, we retain the same train/test (in-sample/out-of-sample) split, and we will apply the same evaluation metrics to NeuralProphet’s forecasts.</p>
<section id="data-formatting">
<h3>Data Formatting<a class="headerlink" href="#data-formatting" title="Permalink to this heading">#</a></h3>
<p>NeuralProphet’s data format is very similar to Prophet’s. We prepare new DataFrames for training and evaluation.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">np_train_df</span> <span class="o">=</span> <span class="n">train_df</span><span class="o">.</span><span class="n">reset_index</span><span class="p">()</span><span class="o">.</span><span class="n">rename</span><span class="p">({</span><span class="s1">&#39;date&#39;</span><span class="p">:</span><span class="s1">&#39;ds&#39;</span><span class="p">,</span> <span class="s1">&#39;USD_CLOSE&#39;</span><span class="p">:</span><span class="s1">&#39;y&#39;</span><span class="p">},</span> <span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span><span class="o">.</span><span class="n">drop</span><span class="p">(</span><span class="s1">&#39;index&#39;</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
<span class="n">np_test_df</span> <span class="o">=</span> <span class="n">test_df</span><span class="o">.</span><span class="n">reset_index</span><span class="p">()</span><span class="o">.</span><span class="n">rename</span><span class="p">({</span><span class="s1">&#39;date&#39;</span><span class="p">:</span><span class="s1">&#39;ds&#39;</span><span class="p">,</span><span class="s1">&#39;USD_CLOSE&#39;</span><span class="p">:</span><span class="s1">&#39;y&#39;</span><span class="p">},</span> <span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span><span class="o">.</span><span class="n">drop</span><span class="p">(</span><span class="s1">&#39;index&#39;</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
</pre></div>
</div>
</div>
</div>
<p>Of course the most important difference between the DataFrames prepared for Prophet and NeuralProphet is that, with NeuralProphet, we have the opportunity to include data about the non-target variables as lagged regressors.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">np_train_df</span><span class="o">.</span><span class="n">head</span><span class="p">(</span><span class="mi">5</span><span class="p">)</span>
</pre></div>
</div>
</div>
</div>
</section>
</section>
<section id="baseline-default-model">
<h2>Baseline/Default Model<a class="headerlink" href="#baseline-default-model" title="Permalink to this heading">#</a></h2>
<p>A baseline NeuralProphet model with lagged regressors using default initialization parameters, except:</p>
<ul class="simple">
<li><p><code class="docutils literal notranslate"><span class="pre">n_lags=lag_time</span></code>, specifying that the autoregressive component of the model should use the past <code class="docutils literal notranslate"><span class="pre">lag_time</span></code> daily observations as inputs</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">n_forecasts=lead_time</span></code>, specifying that our use case is to predict the target signal <code class="docutils literal notranslate"><span class="pre">lead_time</span></code> days into the future</p></li>
</ul>
<p>NeuralProphet also allows you to specify a <code class="docutils literal notranslate"><span class="pre">validation_df</span></code> in <code class="docutils literal notranslate"><span class="pre">fit()</span></code>, on which the model will be evaluated every epoch. We are not using this feature here.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">np_model</span> <span class="o">=</span> <span class="n">NeuralProphet</span><span class="p">(</span><span class="n">n_lags</span><span class="o">=</span><span class="n">lag_time</span><span class="p">,</span> <span class="n">n_forecasts</span><span class="o">=</span><span class="n">lead_time</span><span class="p">)</span>

<span class="c1"># Add the non-target feature columns as lagged regressors</span>
<span class="n">feature_cols</span> <span class="o">=</span> <span class="p">[</span><span class="n">col</span> <span class="k">for</span> <span class="n">col</span> <span class="ow">in</span> <span class="n">np_train_df</span> <span class="k">if</span> <span class="n">col</span> <span class="ow">not</span> <span class="ow">in</span> <span class="p">(</span><span class="s1">&#39;USD_CLOSE&#39;</span><span class="p">,</span> <span class="s1">&#39;ds&#39;</span><span class="p">,</span> <span class="s1">&#39;y&#39;</span><span class="p">)]</span>
<span class="k">for</span> <span class="n">feature</span> <span class="ow">in</span> <span class="n">feature_cols</span><span class="p">:</span>
    <span class="n">np_model</span><span class="o">.</span><span class="n">add_lagged_regressor</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;</span><span class="si">{</span><span class="n">feature</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">)</span>
    
<span class="n">np_model</span><span class="o">.</span><span class="n">fit</span><span class="p">(</span><span class="n">np_train_df</span><span class="p">,</span> <span class="n">freq</span><span class="o">=</span><span class="s1">&#39;D&#39;</span><span class="p">)</span>
</pre></div>
</div>
</div>
</div>
<p>After fitting, you can plot the learned model parameters, including the additional 11 lagged regressors (with 90 day lead time).</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">np_model</span><span class="o">.</span><span class="n">plot_parameters</span><span class="p">()</span>
</pre></div>
</div>
</div>
</div>
<p>NeuralProphet, rather annoyingly, does not collect forecasts into a single yhat variable, but rather into separate <code class="docutils literal notranslate"><span class="pre">stepX</span></code>s for each of the lead times. For example, the following is a single 60-day forecast:</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">x</span><span class="p">,</span> <span class="n">y</span><span class="p">,</span> <span class="n">x_d</span><span class="p">,</span> <span class="n">y_d</span> <span class="o">=</span> <span class="n">test_dataset</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
<span class="n">x</span> <span class="o">=</span> <span class="n">x</span><span class="o">.</span><span class="n">reset_index</span><span class="p">()</span><span class="o">.</span><span class="n">rename</span><span class="p">({</span><span class="s1">&#39;date&#39;</span><span class="p">:</span><span class="s1">&#39;ds&#39;</span><span class="p">,</span> <span class="s1">&#39;USD_CLOSE&#39;</span><span class="p">:</span><span class="s1">&#39;y&#39;</span><span class="p">},</span> <span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span><span class="o">.</span><span class="n">drop</span><span class="p">(</span><span class="s1">&#39;index&#39;</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
<span class="n">x</span> <span class="o">=</span> <span class="n">x</span><span class="o">.</span><span class="n">assign</span><span class="p">(</span><span class="n">ds</span><span class="o">=</span><span class="n">x_d</span><span class="o">.</span><span class="n">reset_index</span><span class="p">()</span><span class="o">.</span><span class="n">drop</span><span class="p">(</span><span class="s1">&#39;index&#39;</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span><span class="o">.</span><span class="n">values</span><span class="p">)</span>
<span class="n">y</span> <span class="o">=</span> <span class="n">y</span><span class="o">.</span><span class="n">reset_index</span><span class="p">()</span><span class="o">.</span><span class="n">rename</span><span class="p">({</span><span class="s1">&#39;date&#39;</span><span class="p">:</span><span class="s1">&#39;ds&#39;</span><span class="p">,</span> <span class="s1">&#39;USD_CLOSE&#39;</span><span class="p">:</span><span class="s1">&#39;y&#39;</span><span class="p">},</span> <span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span><span class="o">.</span><span class="n">drop</span><span class="p">(</span><span class="s1">&#39;index&#39;</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>

<span class="n">np_future_df</span> <span class="o">=</span> <span class="n">np_model</span><span class="o">.</span><span class="n">make_future_dataframe</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">periods</span><span class="o">=</span><span class="nb">len</span><span class="p">(</span><span class="n">y</span><span class="p">))</span>
<span class="n">np_forecast</span> <span class="o">=</span> <span class="n">np_model</span><span class="o">.</span><span class="n">predict</span><span class="p">(</span><span class="n">np_future_df</span><span class="p">,</span> <span class="n">decompose</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">raw</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
<span class="n">np_forecast</span>
</pre></div>
</div>
</div>
</div>
<p>To get a more useable data structure, the following function takes a NeuralProphet forecast dataframe and turns it into a time series of its predictions:</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="k">def</span> <span class="nf">yhat_from_neuralprophet_forecast</span><span class="p">(</span><span class="n">np_forecast</span><span class="p">,</span> <span class="n">y_d</span><span class="p">):</span>
    <span class="k">return</span> <span class="n">pd</span><span class="o">.</span><span class="n">Series</span><span class="p">(</span><span class="n">np_forecast</span><span class="o">.</span><span class="n">T</span><span class="o">.</span><span class="n">iloc</span><span class="p">[</span><span class="mi">1</span><span class="p">:]</span><span class="o">.</span><span class="n">set_index</span><span class="p">(</span><span class="n">y_d</span><span class="p">)</span><span class="o">.</span><span class="n">iloc</span><span class="p">[:,</span><span class="mi">0</span><span class="p">],</span> <span class="n">name</span><span class="o">=</span><span class="s1">&#39;np_yhat&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">rename_axis</span><span class="p">(</span><span class="s1">&#39;ds&#39;</span><span class="p">)</span>
</pre></div>
</div>
</div>
</div>
<p>The forecast from above would now look this:</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">yhat_from_neuralprophet_forecast</span><span class="p">(</span><span class="n">np_forecast</span><span class="p">,</span> <span class="n">y_d</span><span class="p">)</span>
</pre></div>
</div>
</div>
</div>
<p>Since NeuralProphet uses a fixed-size input sequence (lagged observations) to produce forecasts, we iterate over the input sequences in the test set and use them as model inputs to produce forecasts. This mode of inference should be more familiar to machine learning practitioners than Prophet’s. Note that NeuralProphet requires us to first format input data using the <code class="docutils literal notranslate"><span class="pre">make_future_dataframe</span></code> function before running inference using the <code class="docutils literal notranslate"><span class="pre">predict</span></code> function. We define the following function, which produces forecasts for each of the input/ground-truth-output sequences in the test set.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="k">def</span> <span class="nf">collect_np_forecasts</span><span class="p">(</span><span class="n">np_model</span><span class="p">,</span> <span class="n">test_dataset</span><span class="p">):</span>

    <span class="n">forecasts</span> <span class="o">=</span> <span class="p">[]</span>

    <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">test_dataset</span><span class="p">)):</span>
        
        <span class="n">x</span><span class="p">,</span> <span class="n">y</span><span class="p">,</span> <span class="n">x_d</span><span class="p">,</span> <span class="n">y_d</span> <span class="o">=</span> <span class="n">test_dataset</span><span class="p">[</span><span class="n">i</span><span class="p">]</span>
        <span class="n">x</span> <span class="o">=</span> <span class="n">x</span><span class="o">.</span><span class="n">reset_index</span><span class="p">()</span><span class="o">.</span><span class="n">rename</span><span class="p">({</span><span class="s1">&#39;date&#39;</span><span class="p">:</span><span class="s1">&#39;ds&#39;</span><span class="p">,</span> <span class="s1">&#39;USD_CLOSE&#39;</span><span class="p">:</span><span class="s1">&#39;y&#39;</span><span class="p">},</span> <span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span><span class="o">.</span><span class="n">drop</span><span class="p">(</span><span class="s1">&#39;index&#39;</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
        <span class="n">x</span> <span class="o">=</span> <span class="n">x</span><span class="o">.</span><span class="n">assign</span><span class="p">(</span><span class="n">ds</span><span class="o">=</span><span class="n">x_d</span><span class="o">.</span><span class="n">reset_index</span><span class="p">()</span><span class="o">.</span><span class="n">drop</span><span class="p">(</span><span class="s1">&#39;index&#39;</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span><span class="o">.</span><span class="n">values</span><span class="p">)</span>
        <span class="n">y</span> <span class="o">=</span> <span class="n">y</span><span class="o">.</span><span class="n">reset_index</span><span class="p">()</span><span class="o">.</span><span class="n">rename</span><span class="p">({</span><span class="s1">&#39;date&#39;</span><span class="p">:</span><span class="s1">&#39;ds&#39;</span><span class="p">,</span> <span class="s1">&#39;USD_CLOSE&#39;</span><span class="p">:</span><span class="s1">&#39;y&#39;</span><span class="p">},</span> <span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span><span class="o">.</span><span class="n">drop</span><span class="p">(</span><span class="s1">&#39;index&#39;</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>

        <span class="n">np_future_df</span> <span class="o">=</span> <span class="n">np_model</span><span class="o">.</span><span class="n">make_future_dataframe</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">periods</span><span class="o">=</span><span class="nb">len</span><span class="p">(</span><span class="n">y</span><span class="p">))</span>
        <span class="n">np_forecast</span> <span class="o">=</span> <span class="n">np_model</span><span class="o">.</span><span class="n">predict</span><span class="p">(</span><span class="n">np_future_df</span><span class="p">,</span> <span class="n">decompose</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">raw</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
        <span class="n">fc_series</span> <span class="o">=</span> <span class="n">yhat_from_neuralprophet_forecast</span><span class="p">(</span><span class="n">np_forecast</span><span class="p">,</span> <span class="n">y_d</span><span class="p">)</span>
        <span class="n">forecasts</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">fc_series</span><span class="p">)</span>

    <span class="k">return</span> <span class="n">forecasts</span>
</pre></div>
</div>
</div>
</div>
<p>Similarly to what we defined for Prophet, we define the following function for computing and collecting evaluation metrics over all of the forecasts.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="k">def</span> <span class="nf">compute_np_error_metrics</span><span class="p">(</span><span class="n">forecasts</span><span class="p">):</span>

    <span class="n">errors</span> <span class="o">=</span> <span class="p">{</span><span class="n">metric_name</span><span class="p">:[]</span> <span class="k">for</span> <span class="n">metric_name</span> <span class="ow">in</span> <span class="n">metrics</span><span class="o">.</span><span class="n">keys</span><span class="p">()}</span>

    <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">forecasts</span><span class="p">)):</span>
        
        <span class="n">fc</span> <span class="o">=</span> <span class="n">forecasts</span><span class="p">[</span><span class="n">i</span><span class="p">]</span>
        <span class="n">gt</span> <span class="o">=</span> <span class="n">test_df</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">test_df</span><span class="o">.</span><span class="n">date</span><span class="o">.</span><span class="n">isin</span><span class="p">(</span><span class="n">fc</span><span class="o">.</span><span class="n">index</span><span class="p">)]</span><span class="o">.</span><span class="n">sort_values</span><span class="p">(</span><span class="s1">&#39;date&#39;</span><span class="p">)</span>  <span class="c1"># Sorting because I am not 100% sure that the &#39;isin&#39; function always preserves order.</span>
        
        <span class="k">for</span> <span class="n">metric_name</span><span class="p">,</span> <span class="n">metric_fn</span> <span class="ow">in</span> <span class="n">metrics</span><span class="o">.</span><span class="n">items</span><span class="p">():</span> 
                <span class="n">errors</span><span class="p">[</span><span class="n">metric_name</span><span class="p">]</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">metric_fn</span><span class="p">(</span><span class="n">y_true</span><span class="o">=</span><span class="n">gt</span><span class="p">[</span><span class="s1">&#39;USD_CLOSE&#39;</span><span class="p">],</span> <span class="n">y_pred</span><span class="o">=</span><span class="n">fc</span><span class="p">))</span>

    <span class="k">return</span> <span class="n">errors</span><span class="p">,</span> <span class="n">forecasts</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">forecasts</span> <span class="o">=</span> <span class="n">collect_np_forecasts</span><span class="p">(</span><span class="n">np_model</span><span class="p">,</span> <span class="n">test_dataset</span><span class="p">)</span>
<span class="n">np_baseline_error_metrics</span><span class="p">,</span> <span class="n">fcs</span> <span class="o">=</span> <span class="n">compute_np_error_metrics</span><span class="p">(</span><span class="n">forecasts</span><span class="p">)</span>
</pre></div>
</div>
</div>
</div>
<section id="plot-all-forecasts">
<h3>Plot all forecasts<a class="headerlink" href="#plot-all-forecasts" title="Permalink to this heading">#</a></h3>
<p>We have the option to visualize complete forecasts at every time step, but it does not tell us much about the model’s performance.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">fig</span><span class="p">,</span> <span class="n">ax</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">subplots</span><span class="p">(</span><span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="mi">15</span><span class="p">,</span><span class="mi">6</span><span class="p">))</span>

<span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">forecasts</span><span class="p">)):</span>

    <span class="n">fc</span> <span class="o">=</span> <span class="n">forecasts</span><span class="p">[</span><span class="n">i</span><span class="p">]</span>
    <span class="n">gt</span> <span class="o">=</span> <span class="n">test_df</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">test_df</span><span class="o">.</span><span class="n">date</span><span class="o">.</span><span class="n">isin</span><span class="p">(</span><span class="n">fc</span><span class="o">.</span><span class="n">index</span><span class="p">)]</span>

    <span class="n">ax</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">fc</span><span class="o">.</span><span class="n">index</span><span class="p">[:],</span> <span class="n">fc</span><span class="p">[:],</span> <span class="n">alpha</span><span class="o">=</span><span class="mf">0.1</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="s1">&#39;red&#39;</span><span class="p">)</span>
    <span class="n">ax</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">gt</span><span class="o">.</span><span class="n">date</span><span class="p">,</span> <span class="n">gt</span><span class="p">[</span><span class="s1">&#39;USD_CLOSE&#39;</span><span class="p">],</span> <span class="n">alpha</span><span class="o">=</span><span class="mf">0.1</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="s1">&#39;blue&#39;</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">title</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Forecasts at all lead times (1 to </span><span class="si">{</span><span class="n">lead_time</span><span class="si">}</span><span class="s2"> samples)&quot;</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">show</span><span class="p">()</span>
</pre></div>
</div>
</div>
</div>
</section>
<section id="plot-all-forecasts-at-max-lead-time">
<h3>Plot all forecasts at max lead time<a class="headerlink" href="#plot-all-forecasts-at-max-lead-time" title="Permalink to this heading">#</a></h3>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">max_fcs</span> <span class="o">=</span> <span class="p">[{</span><span class="s1">&#39;date&#39;</span><span class="p">:</span> <span class="n">fc</span><span class="o">.</span><span class="n">index</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">:][</span><span class="mi">0</span><span class="p">],</span> <span class="s1">&#39;yhat&#39;</span><span class="p">:</span><span class="n">fc</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">:][</span><span class="mi">0</span><span class="p">]}</span> <span class="k">for</span> <span class="n">fc</span> <span class="ow">in</span> <span class="n">forecasts</span><span class="p">]</span>
<span class="n">max_fcs</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">(</span><span class="n">max_fcs</span><span class="p">)</span>

<span class="n">plt</span><span class="o">.</span><span class="n">figure</span><span class="p">(</span><span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="mi">12</span><span class="p">,</span><span class="mi">3</span><span class="p">))</span>
<span class="n">plt</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">test_df</span><span class="o">.</span><span class="n">date</span><span class="p">,</span> <span class="n">test_df</span><span class="p">[</span><span class="s1">&#39;USD_CLOSE&#39;</span><span class="p">],</span> <span class="n">color</span><span class="o">=</span><span class="s1">&#39;blue&#39;</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="s1">&#39;ground truth&#39;</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">max_fcs</span><span class="o">.</span><span class="n">date</span><span class="p">,</span> <span class="n">max_fcs</span><span class="o">.</span><span class="n">yhat</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="s1">&#39;red&#39;</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="s1">&#39;forecast&#39;</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">title</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Forecasts at max lead time (</span><span class="si">{</span><span class="n">lead_time</span><span class="si">}</span><span class="s2"> samples) - Neural Prophet Default&quot;</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">legend</span><span class="p">(</span><span class="n">loc</span><span class="o">=</span><span class="s1">&#39;upper right&#39;</span><span class="p">)</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># Plot ground truth</span>
<span class="n">plt</span><span class="o">.</span><span class="n">figure</span><span class="p">(</span><span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="mi">12</span><span class="p">,</span><span class="mi">3</span><span class="p">))</span>
<span class="n">ground_truth</span> <span class="o">=</span> <span class="n">test_df</span><span class="p">[[</span><span class="s1">&#39;date&#39;</span><span class="p">,</span> <span class="s1">&#39;USD_CLOSE&#39;</span><span class="p">]]</span>
<span class="n">plt</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">ground_truth</span><span class="o">.</span><span class="n">date</span><span class="p">,</span> <span class="n">ground_truth</span><span class="p">[</span><span class="s1">&#39;USD_CLOSE&#39;</span><span class="p">],</span> <span class="n">label</span><span class="o">=</span><span class="s1">&#39;ground truth&#39;</span><span class="p">)</span>

<span class="c1"># Plot example single forecast</span>
<span class="n">plt</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">forecasts</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">],</span> <span class="n">label</span><span class="o">=</span><span class="s1">&#39;forecast&#39;</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">legend</span><span class="p">()</span>
</pre></div>
</div>
</div>
</div>
</section>
<section id="append-evaluation-metrics-to-results-df">
<h3>Append evaluation metrics to <code class="docutils literal notranslate"><span class="pre">results_df</span></code><a class="headerlink" href="#append-evaluation-metrics-to-results-df" title="Permalink to this heading">#</a></h3>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">results_df</span> <span class="o">=</span> <span class="n">results_df</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">compute_error_statistics</span><span class="p">(</span><span class="n">np_baseline_error_metrics</span><span class="p">,</span> <span class="s1">&#39;neural_prophet_baseline&#39;</span><span class="p">)[</span><span class="s1">&#39;mean&#39;</span><span class="p">])</span>
<span class="n">results_df</span><span class="o">.</span><span class="n">sort_values</span><span class="p">(</span><span class="s1">&#39;mae&#39;</span><span class="p">)</span>
</pre></div>
</div>
</div>
</div>
</section>
</section>
<section id="restricted-model">
<h2>Restricted model<a class="headerlink" href="#restricted-model" title="Permalink to this heading">#</a></h2>
<p>The baseline NeuralProphet model does not perform well on out-of-sample data. We can consider multiple changes to the model’s configuration and hyperparameters in pursuit of better performance. Let’s consider the following configuration that restricts the model to using only the last observed value of last regressors, as opposed to <code class="docutils literal notranslate"><span class="pre">n_lags</span></code> past observations. While less expressive, this model may be less prone to overfitting.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">np_model_last_sample_only</span> <span class="o">=</span> <span class="n">NeuralProphet</span><span class="p">(</span><span class="n">n_lags</span><span class="o">=</span><span class="n">lag_time</span><span class="p">,</span> <span class="n">n_forecasts</span><span class="o">=</span><span class="n">lead_time</span><span class="p">)</span>

<span class="c1"># Add the non-target feature columns as lagged regressors</span>
<span class="n">feature_cols</span> <span class="o">=</span> <span class="p">[</span><span class="n">col</span> <span class="k">for</span> <span class="n">col</span> <span class="ow">in</span> <span class="n">np_train_df</span> <span class="k">if</span> <span class="n">col</span> <span class="ow">not</span> <span class="ow">in</span> <span class="p">(</span><span class="s1">&#39;USD_CLOSE&#39;</span><span class="p">,</span> <span class="s1">&#39;ds&#39;</span><span class="p">,</span> <span class="s1">&#39;y&#39;</span><span class="p">)]</span>
<span class="k">for</span> <span class="n">feature</span> <span class="ow">in</span> <span class="n">feature_cols</span><span class="p">:</span>
    <span class="n">np_model_last_sample_only</span><span class="o">.</span><span class="n">add_lagged_regressor</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;</span><span class="si">{</span><span class="n">feature</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">,</span> <span class="n">only_last_value</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
    
<span class="n">np_model_last_sample_only</span><span class="o">.</span><span class="n">fit</span><span class="p">(</span><span class="n">np_train_df</span><span class="p">,</span> <span class="n">freq</span><span class="o">=</span><span class="s1">&#39;D&#39;</span><span class="p">)</span>
<span class="n">forecasts</span> <span class="o">=</span> <span class="n">collect_np_forecasts</span><span class="p">(</span><span class="n">np_model_last_sample_only</span><span class="p">,</span> <span class="n">test_dataset</span><span class="p">)</span>
<span class="n">np_last_sample_only_error_metrics</span><span class="p">,</span> <span class="n">fcs</span> <span class="o">=</span> <span class="n">compute_np_error_metrics</span><span class="p">(</span><span class="n">forecasts</span><span class="p">)</span>
</pre></div>
</div>
</div>
</div>
<p>Once again, we are able to plot the learned parameters of the model. The lagged regressors are now grouped together in a single chart, as only one value of each is used.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">np_model_last_sample_only</span><span class="o">.</span><span class="n">plot_parameters</span><span class="p">()</span>
</pre></div>
</div>
</div>
</div>
<section id="plot-forecasts-at-max-lead-time">
<h3>Plot forecasts at max lead time<a class="headerlink" href="#plot-forecasts-at-max-lead-time" title="Permalink to this heading">#</a></h3>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">max_fcs</span> <span class="o">=</span> <span class="p">[{</span><span class="s1">&#39;date&#39;</span><span class="p">:</span> <span class="n">fc</span><span class="o">.</span><span class="n">index</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">:][</span><span class="mi">0</span><span class="p">],</span> <span class="s1">&#39;yhat&#39;</span><span class="p">:</span><span class="n">fc</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">:][</span><span class="mi">0</span><span class="p">]}</span> <span class="k">for</span> <span class="n">fc</span> <span class="ow">in</span> <span class="n">forecasts</span><span class="p">]</span>
<span class="n">max_fcs</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">(</span><span class="n">max_fcs</span><span class="p">)</span>

<span class="n">plt</span><span class="o">.</span><span class="n">figure</span><span class="p">(</span><span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="mi">12</span><span class="p">,</span><span class="mi">3</span><span class="p">))</span>
<span class="n">plt</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">test_df</span><span class="o">.</span><span class="n">date</span><span class="p">,</span> <span class="n">test_df</span><span class="p">[</span><span class="s1">&#39;USD_CLOSE&#39;</span><span class="p">],</span> <span class="n">color</span><span class="o">=</span><span class="s1">&#39;blue&#39;</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="s1">&#39;ground truth&#39;</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">max_fcs</span><span class="o">.</span><span class="n">date</span><span class="p">,</span> <span class="n">max_fcs</span><span class="o">.</span><span class="n">yhat</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="s1">&#39;red&#39;</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="s1">&#39;forecast&#39;</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">title</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Forecasts at max lead time (</span><span class="si">{</span><span class="n">lead_time</span><span class="si">}</span><span class="s2"> samples) - Neural Prophet 1-Step Lag&quot;</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">legend</span><span class="p">(</span><span class="n">loc</span><span class="o">=</span><span class="s1">&#39;upper right&#39;</span><span class="p">)</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># Plot ground truth</span>
<span class="n">plt</span><span class="o">.</span><span class="n">figure</span><span class="p">(</span><span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="mi">12</span><span class="p">,</span><span class="mi">3</span><span class="p">))</span>
<span class="n">ground_truth</span> <span class="o">=</span> <span class="n">test_df</span><span class="p">[[</span><span class="s1">&#39;date&#39;</span><span class="p">,</span> <span class="s1">&#39;USD_CLOSE&#39;</span><span class="p">]]</span>
<span class="n">plt</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">ground_truth</span><span class="o">.</span><span class="n">date</span><span class="p">,</span> <span class="n">ground_truth</span><span class="p">[</span><span class="s1">&#39;USD_CLOSE&#39;</span><span class="p">],</span> <span class="n">label</span><span class="o">=</span><span class="s1">&#39;ground truth&#39;</span><span class="p">)</span>

<span class="c1"># Plot example single forecast</span>
<span class="n">plt</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">forecasts</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">],</span> <span class="n">label</span><span class="o">=</span><span class="s1">&#39;forecast&#39;</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">legend</span><span class="p">()</span>
</pre></div>
</div>
</div>
</div>
</section>
<section id="id1">
<h3>Append evaluation metrics to <code class="docutils literal notranslate"><span class="pre">results_df</span></code><a class="headerlink" href="#id1" title="Permalink to this heading">#</a></h3>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">results_df</span> <span class="o">=</span> <span class="n">results_df</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">compute_error_statistics</span><span class="p">(</span><span class="n">np_last_sample_only_error_metrics</span><span class="p">,</span> <span class="s1">&#39;neural_prophet_last_sample_only&#39;</span><span class="p">)[</span><span class="s1">&#39;mean&#39;</span><span class="p">])</span>
<span class="n">results_df</span><span class="o">.</span><span class="n">sort_values</span><span class="p">(</span><span class="s1">&#39;mae&#39;</span><span class="p">)</span>
</pre></div>
</div>
</div>
</div>
</section>
</section>
<section id="model-with-sparse-neural-autoregression">
<h2>Model with Sparse Neural Autoregression<a class="headerlink" href="#model-with-sparse-neural-autoregression" title="Permalink to this heading">#</a></h2>
<p>In the previous parameter plots, you could see high values for all autoregressive features. You can tell NeuralProphet to try avoiding relying on them too much by restricting how many of them it is able to use. In this case, we set <code class="docutils literal notranslate"><span class="pre">ar_reg</span></code> to 10, which imposes a strong regularization of the AR model towards sparsity in its coefficients. We also reduce the AR depth to 10 days. <em>Note</em>: NeuralProphet applies this sparsity factor only to the regular AR coefficients, not the lagged regressor AR coefficients, where higher sparsity would make more sense.</p>
<p>We can also play around with parameters like the number of hidden layers or the learning rate of the AR-Net. Another change applied to this model is the loss function, now MAE instead of the default Huber loss.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">np_model_sparse_nar</span> <span class="o">=</span> <span class="n">NeuralProphet</span><span class="p">(</span><span class="n">n_lags</span><span class="o">=</span><span class="mi">10</span><span class="p">,</span> 
                                    <span class="n">n_forecasts</span><span class="o">=</span><span class="n">lead_time</span><span class="p">,</span>
                                    <span class="n">ar_reg</span><span class="o">=</span><span class="mi">10</span><span class="p">,</span>
                                    <span class="n">learning_rate</span><span class="o">=</span><span class="mf">5e-3</span><span class="p">,</span>
                                    <span class="n">num_hidden_layers</span><span class="o">=</span><span class="mi">2</span><span class="p">,</span>
                                    <span class="n">d_hidden</span><span class="o">=</span><span class="mi">16</span><span class="p">,</span>
                                    <span class="n">loss_func</span><span class="o">=</span><span class="s1">&#39;MAE&#39;</span>
                                    <span class="p">)</span>

<span class="c1"># Add the non-target feature columns as lagged regressors</span>
<span class="n">feature_cols</span> <span class="o">=</span> <span class="p">[</span><span class="n">col</span> <span class="k">for</span> <span class="n">col</span> <span class="ow">in</span> <span class="n">np_train_df</span> <span class="k">if</span> <span class="n">col</span> <span class="ow">not</span> <span class="ow">in</span> <span class="p">(</span><span class="s1">&#39;USD_CLOSE&#39;</span><span class="p">,</span> <span class="s1">&#39;ds&#39;</span><span class="p">,</span> <span class="s1">&#39;y&#39;</span><span class="p">)]</span>
<span class="k">for</span> <span class="n">feature</span> <span class="ow">in</span> <span class="n">feature_cols</span><span class="p">:</span>
    <span class="n">np_model_sparse_nar</span><span class="o">.</span><span class="n">add_lagged_regressor</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;</span><span class="si">{</span><span class="n">feature</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">,</span> <span class="n">n_lags</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
    
<span class="n">np_model_sparse_nar</span><span class="o">.</span><span class="n">fit</span><span class="p">(</span><span class="n">np_train_df</span><span class="p">,</span> <span class="n">freq</span><span class="o">=</span><span class="s1">&#39;D&#39;</span><span class="p">)</span>
<span class="n">forecasts</span> <span class="o">=</span> <span class="n">collect_np_forecasts</span><span class="p">(</span><span class="n">np_model_sparse_nar</span><span class="p">,</span> <span class="n">test_dataset</span><span class="p">)</span>
<span class="n">np_sparse_ar_error_metrics</span><span class="p">,</span> <span class="n">fcs</span> <span class="o">=</span> <span class="n">compute_np_error_metrics</span><span class="p">(</span><span class="n">forecasts</span><span class="p">)</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">np_model_sparse_nar</span><span class="o">.</span><span class="n">plot_parameters</span><span class="p">()</span>
</pre></div>
</div>
</div>
</div>
<section id="id2">
<h3>Plot forecasts at max lead time<a class="headerlink" href="#id2" title="Permalink to this heading">#</a></h3>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">max_fcs</span> <span class="o">=</span> <span class="p">[{</span><span class="s1">&#39;date&#39;</span><span class="p">:</span> <span class="n">fc</span><span class="o">.</span><span class="n">index</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">:][</span><span class="mi">0</span><span class="p">],</span> <span class="s1">&#39;yhat&#39;</span><span class="p">:</span><span class="n">fc</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">:][</span><span class="mi">0</span><span class="p">]}</span> <span class="k">for</span> <span class="n">fc</span> <span class="ow">in</span> <span class="n">forecasts</span><span class="p">]</span>
<span class="n">max_fcs</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">(</span><span class="n">max_fcs</span><span class="p">)</span>

<span class="n">plt</span><span class="o">.</span><span class="n">figure</span><span class="p">(</span><span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="mi">12</span><span class="p">,</span><span class="mi">3</span><span class="p">))</span>
<span class="n">plt</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">test_df</span><span class="o">.</span><span class="n">date</span><span class="p">,</span> <span class="n">test_df</span><span class="p">[</span><span class="s1">&#39;USD_CLOSE&#39;</span><span class="p">],</span> <span class="n">color</span><span class="o">=</span><span class="s1">&#39;blue&#39;</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="s1">&#39;ground truth&#39;</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">max_fcs</span><span class="o">.</span><span class="n">date</span><span class="p">,</span> <span class="n">max_fcs</span><span class="o">.</span><span class="n">yhat</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="s1">&#39;red&#39;</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="s1">&#39;forecast&#39;</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">title</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Forecasts at max lead time (</span><span class="si">{</span><span class="n">lead_time</span><span class="si">}</span><span class="s2"> samples) - Neural Prophet Sparse&quot;</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">legend</span><span class="p">(</span><span class="n">loc</span><span class="o">=</span><span class="s1">&#39;upper right&#39;</span><span class="p">)</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># Plot ground truth</span>
<span class="n">plt</span><span class="o">.</span><span class="n">figure</span><span class="p">(</span><span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="mi">12</span><span class="p">,</span><span class="mi">3</span><span class="p">))</span>
<span class="n">ground_truth</span> <span class="o">=</span> <span class="n">test_df</span><span class="p">[[</span><span class="s1">&#39;date&#39;</span><span class="p">,</span> <span class="s1">&#39;USD_CLOSE&#39;</span><span class="p">]]</span>
<span class="n">plt</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">ground_truth</span><span class="o">.</span><span class="n">date</span><span class="p">,</span> <span class="n">ground_truth</span><span class="p">[</span><span class="s1">&#39;USD_CLOSE&#39;</span><span class="p">],</span> <span class="n">label</span><span class="o">=</span><span class="s1">&#39;ground truth&#39;</span><span class="p">)</span>

<span class="c1"># Plot example single forecast</span>
<span class="n">plt</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">forecasts</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">],</span> <span class="n">label</span><span class="o">=</span><span class="s1">&#39;forecast&#39;</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">legend</span><span class="p">()</span>
</pre></div>
</div>
</div>
</div>
</section>
<section id="id3">
<h3>Append evaluation metrics to <code class="docutils literal notranslate"><span class="pre">results_df</span></code><a class="headerlink" href="#id3" title="Permalink to this heading">#</a></h3>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">results_df</span> <span class="o">=</span> <span class="n">results_df</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">compute_error_statistics</span><span class="p">(</span><span class="n">np_sparse_ar_error_metrics</span><span class="p">,</span> <span class="s1">&#39;neural_prophet_sparse_ar&#39;</span><span class="p">)[</span><span class="s1">&#39;mean&#39;</span><span class="p">])</span>
<span class="n">results_df</span><span class="o">.</span><span class="n">sort_values</span><span class="p">(</span><span class="s1">&#39;mae&#39;</span><span class="p">)</span>
</pre></div>
</div>
</div>
</div>
</section>
</section>
<section id="reflections-and-next-steps">
<h2>Reflections and Next Steps<a class="headerlink" href="#reflections-and-next-steps" title="Permalink to this heading">#</a></h2>
<p>So far, the best performing ‘model’ is the persistence forecasting model. This is, of course, an unsatisfactory result. The best performing experimental model on the exchange rates dataset is the restricted NeuralProphet model that uses only the last observation of lagged regressors as features. Of course, we have only considered a very small number of configurations using NeuralProphet, many more model and hyperparameter configurations are possible. Please refer to the <a class="reference external" href="https://neuralprophet.com/html/contents.html">NeuralProphet documentation</a> for detailed information. However, to <em>find</em> a better configuration may require significant effort, either manual or automated (via a hyperparameter search, for example). In practical forecasting use cases, it may be important to consider the time, resources, and effort that are needed to find a forecasting model that is better than  baseline.</p>
<p>The following notebooks in this series will cover additional models (N-BEATS and DeepAR) as well as rolling cross validation using NeuralProphet. In order to compare the out-of-sample forecasts produced by this notebook to others, the <code class="docutils literal notranslate"><span class="pre">results_df</span></code> DataFrame is saved below. Hopefully we will find a model that performs better than baseline in a continued out-of-sample evaluation experiment!</p>
<p><em>Note</em> The path here should be changed to your local drive folder in order for it to be retrieved in other notebooks. See the beginning of this notebook for context.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">output_filename</span> <span class="o">=</span> <span class="s2">&quot;/h/kkoch/forecasting-bootcamp/demos/exchange_rate_mean_test_metrics.csv&quot;</span>
<span class="n">results_df</span><span class="o">.</span><span class="n">to_csv</span><span class="p">(</span><span class="n">output_filename</span><span class="p">)</span>
</pre></div>
</div>
</div>
</div>
</section>
</section>

    <script type="text/x-thebe-config">
    {
        requestKernel: true,
        binderOptions: {
            repo: "binder-examples/jupyter-stacks-datascience",
            ref: "master",
        },
        codeMirrorConfig: {
            theme: "abcdef",
            mode: "python"
        },
        kernelOptions: {
            name: "python3",
            path: "./demos"
        },
        predefinedOutput: true
    }
    </script>
    <script>kernelName = 'python3'</script>

                </article>
              

              
              
                <footer class="bd-footer-article">
                  
<div class="footer-article-items footer-article__inner">
  
    <div class="footer-article-item"><!-- Previous / next buttons -->
<div class="prev-next-area">
    <a class="left-prev"
       href="../intro_to_forecasting/intro_time_series_2.html"
       title="previous page">
      <i class="fa-solid fa-angle-left"></i>
      <div class="prev-next-info">
        <p class="prev-next-subtitle">previous</p>
        <p class="prev-next-title">Intro to Time Series Forecasting and Evaluation</p>
      </div>
    </a>
    <a class="right-next"
       href="demo2_pytorch_forecasting-NBEATS-CPI.html"
       title="next page">
      <div class="prev-next-info">
        <p class="prev-next-subtitle">next</p>
        <p class="prev-next-title">PyTorch Forecasting - NBEATS</p>
      </div>
      <i class="fa-solid fa-angle-right"></i>
    </a>
</div></div>
  
</div>

                </footer>
              
            </div>
            
            
              
                <div class="bd-sidebar-secondary bd-toc"><div class="sidebar-secondary-items sidebar-secondary__inner">

  <div class="sidebar-secondary-item">
  <div class="page-toc tocsection onthispage">
    <i class="fa-solid fa-list"></i> Contents
  </div>
  <nav class="bd-toc-nav page-toc">
    <ul class="visible nav section-nav flex-column">
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#data-loading">Data Loading</a><ul class="nav section-nav flex-column">
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#load-exchange-rate-data-file">Load exchange rate data file</a></li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#split-data-according-to-use-case">Split data according to use case</a></li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#iterating-over-test-examples">Iterating over test examples</a></li>
</ul>
</li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#evaluation-metrics">Evaluation Metrics</a></li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#baseline-forecasts">Baseline Forecasts</a><ul class="nav section-nav flex-column">
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#compute-error-metrics-over-the-baseline-forecasts">Compute error metrics over the baseline forecasts</a></li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#visualizing-forecasts-over-the-test-set">Visualizing forecasts over the test set</a><ul class="nav section-nav flex-column">
<li class="toc-h4 nav-item toc-entry"><a class="reference internal nav-link" href="#persistence-forecasts-at-max-lead-time">Persistence Forecasts At Max Lead Time</a></li>
<li class="toc-h4 nav-item toc-entry"><a class="reference internal nav-link" href="#mean-window-forecasts-at-max-lead-time">Mean Window Forecasts At Max Lead Time</a></li>
</ul>
</li>
</ul>
</li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#prophet">Prophet</a><ul class="nav section-nav flex-column">
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#data-preparation">Data Preparation</a></li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#model-initialization-and-fitting">Model Initialization and Fitting</a></li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#produce-forecasts">Produce Forecasts</a></li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#plotting-prophet-forecasts">Plotting Prophet Forecasts</a></li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#prophet-forecasts-at-max-lead-time">Prophet Forecasts At Max Lead Time</a></li>
</ul>
</li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#neuralprophet">NeuralProphet</a><ul class="nav section-nav flex-column">
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#data-formatting">Data Formatting</a></li>
</ul>
</li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#baseline-default-model">Baseline/Default Model</a><ul class="nav section-nav flex-column">
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#plot-all-forecasts">Plot all forecasts</a></li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#plot-all-forecasts-at-max-lead-time">Plot all forecasts at max lead time</a></li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#append-evaluation-metrics-to-results-df">Append evaluation metrics to <code class="docutils literal notranslate"><span class="pre">results_df</span></code></a></li>
</ul>
</li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#restricted-model">Restricted model</a><ul class="nav section-nav flex-column">
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#plot-forecasts-at-max-lead-time">Plot forecasts at max lead time</a></li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#id1">Append evaluation metrics to <code class="docutils literal notranslate"><span class="pre">results_df</span></code></a></li>
</ul>
</li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#model-with-sparse-neural-autoregression">Model with Sparse Neural Autoregression</a><ul class="nav section-nav flex-column">
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#id2">Plot forecasts at max lead time</a></li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#id3">Append evaluation metrics to <code class="docutils literal notranslate"><span class="pre">results_df</span></code></a></li>
</ul>
</li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#reflections-and-next-steps">Reflections and Next Steps</a></li>
</ul>
  </nav></div>

</div></div>
              
            
          </div>
          <footer class="bd-footer-content">
            
<div class="bd-footer-content__inner container">
  
  <div class="footer-item">
    
<p class="component-author">
By Vector Institute
</p>

  </div>
  
  <div class="footer-item">
    
  <p class="copyright">
    
      © Copyright 2023.
      <br/>
    
  </p>

  </div>
  
  <div class="footer-item">
    
  </div>
  
  <div class="footer-item">
    
  </div>
  
</div>
          </footer>
        

      </main>
    </div>
  </div>
  
  <!-- Scripts loaded after <body> so the DOM is not blocked -->
  <script src="../_static/scripts/bootstrap.js?digest=e353d410970836974a52"></script>
<script src="../_static/scripts/pydata-sphinx-theme.js?digest=e353d410970836974a52"></script>

  <footer class="bd-footer">
  </footer>
  </body>
</html>